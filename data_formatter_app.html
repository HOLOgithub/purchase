<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スマート調達分析システム（SPAS）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex flex-col min-h-screen p-4">
        <header class="mb-6">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-2xl font-bold text-blue-700">スマート調達分析システム（SPAS）</h1>
                    <p class="text-gray-600 mt-1">Smart Procurement Analysis System - 調達データの高度分析・検証プラットフォーム</p>
                </div>
                <div class="text-right">
                    <div class="inline-flex items-center bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">
                        <span class="mr-1">✨</span>
                        <span id="appVersion">v3.0.0</span>
                    </div>
                    <button id="versionInfoBtn" class="mt-1 text-xs text-green-600 hover:text-green-800 underline">
                        更新履歴を表示
                    </button>
                </div>
            </div>
        </header>
        
        <!-- 入力セクション -->
        <section class="mb-4">
            <div class="bg-white p-6 rounded-lg shadow border">
                <h2 class="text-lg font-semibold mb-4 text-gray-800">データ入力</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            生データ
                        </label>
                        <textarea
                            id="inputData"
                            class="w-full h-32 p-3 border rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                            placeholder="複数案件の生データを貼り付け（案件ごとに改行区切り）"
                        ></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            申請単価・注文数データ
                        </label>
                        <textarea
                            id="applicationData"
                            class="w-full h-24 p-3 border rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                            placeholder="申請単価と注文数を貼り付け（例：0.75sqx2C：@14600円/13個）"
                        ></textarea>
                    </div>
                    
                    <div class="flex gap-3">
                        <button
                            id="processDataBtn"
                            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            データ処理
                        </button>
                        <button
                            id="clearBtn"
                            class="px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors"
                        >
                            クリア
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 案件一覧セクション -->
        <section id="projectsSection" class="bg-white rounded-lg shadow border fade-in" style="display: none;">
            <div class="p-6">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-gray-800">
                        案件一覧（<span id="projectCount" class="text-blue-600">0</span>件）
                    </h2>
                </div>
                
                <!-- 案件リスト -->
                <div id="projectsList" class="space-y-6">
                    <!-- 案件が動的に生成される -->
                </div>
                
                <!-- 一括検証ボタン -->
                <div class="mt-8 flex justify-center">
                    <button
                        id="validateAllBtn"
                        class="px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors font-medium text-lg shadow-md"
                    >
                        🔍 一括検証実行
                    </button>
                </div>
                
                <!-- 全体結果表示 -->
                <div id="overallResults" class="mt-8 fade-in" style="display: none;">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800 border-b pb-2">検証結果一覧</h3>
                    <div id="overallResultsContent"></div>
                    
                    <!-- フォーマット済みテキスト -->
                    <div id="formattedTextSection" class="mt-8 fade-in" style="display: none;">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800 border-b pb-2">フォーマット済みテキスト</h3>
                        <div id="formattedText" class="bg-gray-100 p-4 rounded-lg whitespace-pre-line text-sm font-mono border"></div>
                        <button
                            id="copyBtn"
                            class="mt-3 px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                        >
                            📋 クリップボードにコピー
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- バージョン情報モーダル -->
        <div id="versionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">バージョン情報・更新履歴</h3>
                    <button id="closeVersionModal" class="text-gray-500 hover:text-gray-700 text-xl">×</button>
                </div>
                
                <div class="space-y-4">
                    <!-- Current Version -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center mb-2">
                            <span class="bg-green-600 text-white px-2 py-1 rounded text-sm font-medium mr-2">LATEST</span>
                            <span class="font-bold text-green-700">v3.0.0</span>
                            <span class="text-gray-600 ml-2">- 2025年1月（コードリファクタリング版）</span>
                        </div>
                        <h4 class="font-semibold text-gray-800 mb-2">🔄 完全リファクタリング・コード品質向上</h4>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li>• <strong>コード構造の最適化:</strong> クラス設計の見直しと責務の明確化</li>
                            <li>• <strong>バージョン管理の強化:</strong> セマンティックバージョニングの厳格な運用</li>
                            <li>• <strong>更新履歴の整理:</strong> 変更内容の明確な記録と追跡性の向上</li>
                            <li>• <strong>保守性の向上:</strong> コードの可読性と拡張性の改善</li>
                            <li>• <strong>ドキュメント整備:</strong> コード内コメントとバージョン情報の充実</li>
                        </ul>

                        <div class="mt-3 p-2 bg-green-100 border border-green-300 rounded text-sm">
                            <div class="flex items-center">
                                <span class="text-green-600 mr-2">🔄</span>
                                <strong class="text-green-800">メジャーアップデート</strong>
                                <span class="text-green-700 ml-2">= コード品質と保守性の大幅向上</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Version History -->
                    <div class="space-y-3">
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <span class="font-bold text-gray-700">v2.4.3</span>
                                <span class="text-gray-600 ml-2">- 2024年12月（出力表示機能改善版）</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">📋 出力表示機能改善</h4>
                            <ul class="text-sm text-gray-700 space-y-1">
                                <li>• 加工費比較ON/OFF時の条件分岐表示</li>
                                <li>• 専用出力フォーマット実装</li>
                                <li>• 出力精度向上</li>
                            </ul>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <span class="font-bold text-gray-700">v2.3.4</span>
                                <span class="text-gray-600 ml-2">- 2024年12月（加工費比較機能追加版）</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">🔧 加工費比較機能実装</h4>
                            <ul class="text-sm text-gray-700 space-y-1">
                                <li>• 加工費比較チェックボックス機能</li>
                                <li>• 前回加工費との自動比較</li>
                                <li>• 加工費上昇時の理由記載機能</li>
                            </ul>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <span class="font-bold text-gray-700">v2.3.3</span>
                                <span class="text-gray-600 ml-2">- 2024年12月（図番チェック機能追加版）</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">📐 図番チェック機能実装</h4>
                            <ul class="text-sm text-gray-700 space-y-1">
                                <li>• 図番チェック機能追加</li>
                                <li>• 図番なしオプション対応</li>
                                <li>• 図番不一致対応</li>
                                <li>• フォーマット出力改善</li>
                            </ul>
                        </div>
                        
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <span class="font-bold text-gray-700">v2.3.0</span>
                                <span class="text-gray-600 ml-2">- 2024年12月</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">✏️ 基本情報編集機能実装</h4>
                            <ul class="text-sm text-gray-700 space-y-1">
                                <li>• 基本情報の直接編集機能</li>
                                <li>• インライン編集UI</li>
                                <li>• リアルタイム検証連携</li>
                                <li>• データ品質向上</li>
                            </ul>
                        </div>
                        
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <span class="font-bold text-gray-700">v2.2.0</span>
                                <span class="text-gray-600 ml-2">- 2024年12月</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">⚡ リアルタイム検証機能実装</h4>
                            <ul class="text-sm text-gray-700 space-y-1">
                                <li>• リアルタイム検証エンジン</li>
                                <li>• デバウンス機能による負荷軽減</li>
                                <li>• ビジュアルフィードバック</li>
                                <li>• インテリジェントヒント表示</li>
                            </ul>
                        </div>
                        
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <span class="font-bold text-gray-700">v2.1.1</span>
                                <span class="text-gray-600 ml-2">- 2024年12月</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">📋 基本情報表示の仕様変更</h4>
                            <ul class="text-sm text-gray-700 space-y-1">
                                <li>• 題目表示ルール変更</li>
                                <li>• 基本情報の順番変更</li>
                                <li>• 在庫数、前回注文加工費追加</li>
                                <li>• データ品質評価基準調整</li>
                            </ul>
                        </div>
                        
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <span class="font-bold text-gray-700">v2.1.0</span>
                                <span class="text-gray-600 ml-2">- 2024年12月</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">🎯 データ表示・解析機能強化</h4>
                            <ul class="text-sm text-gray-700 space-y-1">
                                <li>• データ解析エンジンの完全刷新</li>
                                <li>• 「不明」表示の撲滅</li>
                                <li>• データ品質インジケーター追加</li>
                                <li>• 申請データマッチング強化</li>
                            </ul>
                        </div>
                        
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <span class="font-bold text-gray-700">v2.0.0</span>
                                <span class="text-gray-600 ml-2">- 2024年12月</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">🚀 Major Update - 完全リファクタリング</h4>
                            <ul class="text-sm text-gray-700 space-y-1">
                                <li>• アーキテクチャ改善とクラス化</li>
                                <li>• エラーハンドリング強化</li>
                                <li>• 税込/税抜計算機能追加</li>
                                <li>• UI/UX大幅改善</li>
                            </ul>
                        </div>
                        
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <span class="font-bold text-gray-700">v1.2.1</span>
                                <span class="text-gray-600 ml-2">- 2024年11月</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">🔧 Bug Fixes & Improvements</h4>
                            <ul class="text-sm text-gray-700 space-y-1">
                                <li>• 型番検証ロジックの修正</li>
                                <li>• 価格計算の精度向上</li>
                                <li>• UIレスポンシブ対応の改善</li>
                            </ul>
                        </div>
                        
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <span class="font-bold text-gray-700">v1.2.0</span>
                                <span class="text-gray-600 ml-2">- 2024年10月</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">✨ Feature Updates</h4>
                            <ul class="text-sm text-gray-700 space-y-1">
                                <li>• 一括検証機能の追加</li>
                                <li>• フォーマット済みテキスト出力機能</li>
                                <li>• クリップボードコピー機能</li>
                            </ul>
                        </div>
                        
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <span class="font-bold text-gray-700">v1.1.0</span>
                                <span class="text-gray-600 ml-2">- 2024年9月</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">🎯 Core Features</h4>
                            <ul class="text-sm text-gray-700 space-y-1">
                                <li>• 複数案件対応の実装</li>
                                <li>• 申請データ自動マッチング</li>
                                <li>• リアルタイム計算機能</li>
                            </ul>
                        </div>
                        
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <span class="font-bold text-gray-700">v1.0.0</span>
                                <span class="text-gray-600 ml-2">- 2024年8月</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">🎉 Initial Release</h4>
                            <ul class="text-sm text-gray-700 space-y-1">
                                <li>• 基本的なデータ整形機能</li>
                                <li>• 単一案件対応</li>
                                <li>• 基本的な検証機能</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Technical Info -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-2">🔧 技術情報</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <strong>フレームワーク:</strong> Vanilla JavaScript
                            </div>
                            <div>
                                <strong>スタイリング:</strong> Tailwind CSS
                            </div>
                            <div>
                                <strong>アーキテクチャ:</strong> Class-based Modular
                            </div>
                            <div>
                                <strong>ブラウザ対応:</strong> Modern Browsers
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- エラー表示 -->
        <div id="errorMessage" class="fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded shadow-lg" style="display: none;">
            <div class="flex justify-between items-center">
                <span id="errorText"></span>
                <button onclick="this.parentElement.parentElement.style.display='none'" class="ml-2 text-red-500 hover:text-red-700">×</button>
            </div>
        </div>
        
        <!-- 成功メッセージ -->
        <div id="successMessage" class="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded shadow-lg" style="display: none;">
            <div class="flex justify-between items-center">
                <span id="successText"></span>
                <button onclick="this.parentElement.parentElement.style.display='none'" class="ml-2 text-green-500 hover:text-green-700">×</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * =============================================================================
         * SPAS - スマート調達分析システム (Smart Procurement Analysis System)
         * =============================================================================
         * Version: 3.0.0
         * Release Date: 2025年1月
         *
         * 主要更新内容 (v3.0.0):
         * - コード構造の最適化とクラス設計の見直し
         * - バージョン管理の強化（セマンティックバージョニング）
         * - 更新履歴の整理と追跡性の向上
         * - 保守性とコードの可読性の改善
         *
         * アーキテクチャ:
         * - DataFormatterApp: メインアプリケーションクラス
         * - DataParser: データ解析エンジン
         * - ProjectValidator: 検証ロジック
         * - UIGenerator: UI生成エンジン
         * - ProjectEventHandler: イベント処理
         * - TextFormatter: 出力フォーマッタ
         * - VersionManager: バージョン管理
         * - NotificationManager: 通知管理
         * =============================================================================
         */

        // アプリケーションメインクラス
        class DataFormatterApp {
            constructor() {
                this.version = '3.0.0';
                this.projects = [];
                this.applicationDataMap = new Map();
                this.elements = this.initializeElements();
                this.dataParser = new DataParser();
                this.validator = new ProjectValidator();
                this.uiGenerator = new UIGenerator();
                this.notificationManager = new NotificationManager();
                this.versionManager = new VersionManager(this.version);
                
                this.bindEvents();
                this.initialize();
            }
            
            initializeElements() {
                const elementIds = [
                    'inputData', 'applicationData', 'processDataBtn', 'clearBtn',
                    'projectsSection', 'projectCount', 'validateAllBtn', 'projectsList',
                    'overallResults', 'overallResultsContent', 'formattedTextSection',
                    'formattedText', 'copyBtn', 'versionInfoBtn', 'versionModal', 'closeVersionModal'
                ];
                
                return elementIds.reduce((acc, id) => {
                    const element = document.getElementById(id);
                    if (!element) {
                        console.warn(`Element with id '${id}' not found`);
                    }
                    acc[id] = element;
                    return acc;
                }, {});
            }
            
            bindEvents() {
                this.elements.processDataBtn?.addEventListener('click', () => this.handleProcessData());
                this.elements.clearBtn?.addEventListener('click', () => this.clearAll());
                this.elements.validateAllBtn?.addEventListener('click', () => this.handleValidateAll());
                this.elements.copyBtn?.addEventListener('click', () => this.copyToClipboard());
                this.elements.versionInfoBtn?.addEventListener('click', () => this.versionManager.showVersionModal());
                this.elements.closeVersionModal?.addEventListener('click', () => this.versionManager.hideVersionModal());
                
                // モーダル背景クリックで閉じる
                this.elements.versionModal?.addEventListener('click', (e) => {
                    if (e.target === this.elements.versionModal) {
                        this.versionManager.hideVersionModal();
                    }
                });
            }
            
            initialize() {
                this.elements.inputData?.focus();
                this.versionManager.displayVersion();
                this.versionManager.logVersionInfo();
            }
            
            async handleProcessData() {
                try {
                    this.toggleProcessingState(true);
                    
                    const rawData = this.elements.inputData?.value?.trim();
                    const applicationDataText = this.elements.applicationData?.value?.trim();
                    
                    if (!rawData) {
                        throw new Error('生データを入力してください');
                    }
                    
                    console.group('📊 データ処理開始');
                    
                    // データ解析
                    this.projects = this.dataParser.parseRawData(rawData);
                    this.applicationDataMap = this.dataParser.parseApplicationData(applicationDataText);
                    
                    if (this.projects.length === 0) {
                        throw new Error('解析できる案件データが見つかりませんでした。データ形式を確認してください。');
                    }
                    
                    // データ品質レポート
                    const qualityReport = this.generateDataQualityReport();
                    console.log('📈 データ品質レポート:', qualityReport);
                    
                    // UI更新
                    this.updateProjectsUI();
                    
                    // 詳細な成功メッセージ
                    const matchCount = this.countSuccessfulMatches();
                    this.notificationManager.showSuccess(
                        `✅ ${this.projects.length}件の案件を処理しました | 申請データマッチング: ${matchCount}/${this.projects.length}件`
                    );
                    
                    console.groupEnd();
                    
                } catch (error) {
                    this.notificationManager.showError(error.message);
                    console.error('❌ データ処理エラー:', error);
                    console.groupEnd();
                } finally {
                    this.toggleProcessingState(false);
                }
            }
            
            generateDataQualityReport() {
                let totalFields = 0;
                let filledFields = 0;
                const missingData = [];
                
                this.projects.forEach((project, index) => {
                    const basicInfo = project.basicInfo;
                    const requiredFields = ['仕様', '型番', '在庫数', '年間使用数', '前回の注文単価'];
                    
                    requiredFields.forEach(field => {
                        totalFields++;
                        const value = basicInfo[field];
                        if (value && value !== '未指定' && value !== '0' && !value.includes('案件') && !value.includes('TYPE-') && !value.includes('物品')) {
                            filledFields++;
                        } else {
                            const fieldLabel = field === '仕様' ? '物品名' : field;
                            missingData.push(`案件${index + 1}: ${fieldLabel}`);
                        }
                    });
                });
                
                return {
                    completeness: Math.round((filledFields / totalFields) * 100),
                    filledFields,
                    totalFields,
                    missingData: missingData.slice(0, 5) // 最初の5件のみ表示
                };
            }
            
            countSuccessfulMatches() {
                return this.projects.filter(project => 
                    this.uiGenerator.findMatchingApplication(project.basicInfo, this.applicationDataMap) !== null
                ).length;
            }
            
            updateProjectsUI() {
                if (this.elements.projectCount) {
                    this.elements.projectCount.textContent = this.projects.length;
                }
                
                if (this.elements.projectsSection) {
                    this.elements.projectsSection.style.display = 'block';
                }
                
                if (this.elements.projectsList) {
                    this.elements.projectsList.innerHTML = this.projects
                        .map((project, index) => this.uiGenerator.generateProjectHTML(project, index, this.applicationDataMap))
                        .join('');
                    
                    this.setupProjectEventListeners();
                }
            }
            
            setupProjectEventListeners() {
                const projectElements = this.elements.projectsList?.querySelectorAll('[data-project-index]');
                
                projectElements?.forEach(projectElement => {
                    const eventHandler = new ProjectEventHandler(projectElement, this.validator);
                    eventHandler.setup();
                    
                    // リアルタイム機能の管理
                    projectElement.eventHandler = eventHandler;
                });
                
                // リアルタイム機能のグローバル制御を追加
                this.addRealTimeControls();
            }
            
            addRealTimeControls() {
                // リアルタイム機能の制御ボタンを追加
                const controlsContainer = this.elements.projectsList?.parentElement;
                if (!controlsContainer) return;
                
                const existingControls = controlsContainer.querySelector('.realtime-controls');
                if (existingControls) existingControls.remove();
                
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'realtime-controls mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg';
                controlsDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="mr-3 text-sm font-medium text-blue-700">⚡ リアルタイム検証</span>
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="realtimeToggle" class="rounded text-blue-600 focus:ring-blue-500" checked />
                                <span class="ml-2 text-sm text-blue-700">有効</span>
                            </label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="clearCacheBtn" class="px-3 py-1 text-xs bg-white border border-blue-300 text-blue-700 rounded hover:bg-blue-50">
                                🗑️ キャッシュクリア
                            </button>
                            <button id="validateAllRealTimeBtn" class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">
                                🔄 全件再検証
                            </button>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-blue-600">
                        💡 入力値を変更すると自動的に検証が実行されます（500ms遅延）
                    </div>
                `;
                
                controlsContainer.insertBefore(controlsDiv, this.elements.projectsList);
                
                // イベントリスナーの設定
                this.setupRealTimeControlEvents();
            }
            
            setupRealTimeControlEvents() {
                const realtimeToggle = document.getElementById('realtimeToggle');
                const clearCacheBtn = document.getElementById('clearCacheBtn');
                const validateAllRealTimeBtn = document.getElementById('validateAllRealTimeBtn');
                
                realtimeToggle?.addEventListener('change', (e) => {
                    const isEnabled = e.target.checked;
                    this.toggleRealTimeValidation(isEnabled);
                    
                    const statusMessage = isEnabled ? 'リアルタイム検証が有効になりました' : 'リアルタイム検証が無効になりました';
                    this.notificationManager.showSuccess(statusMessage);
                });
                
                clearCacheBtn?.addEventListener('click', () => {
                    this.clearAllValidationCaches();
                    this.notificationManager.showSuccess('検証キャッシュをクリアしました');
                });
                
                validateAllRealTimeBtn?.addEventListener('click', () => {
                    this.forceRealTimeValidationAll();
                    this.notificationManager.showSuccess('全案件のリアルタイム検証を実行しました');
                });
            }
            
            toggleRealTimeValidation(enabled) {
                const projectElements = this.elements.projectsList?.querySelectorAll('[data-project-index]');
                projectElements?.forEach(element => {
                    element.eventHandler?.toggleRealTimeValidation(enabled);
                });
            }
            
            clearAllValidationCaches() {
                const projectElements = this.elements.projectsList?.querySelectorAll('[data-project-index]');
                projectElements?.forEach(element => {
                    element.eventHandler?.clearValidationCache();
                });
            }
            
            forceRealTimeValidationAll() {
                const projectElements = this.elements.projectsList?.querySelectorAll('[data-project-index]');
                projectElements?.forEach(element => {
                    element.eventHandler?.triggerRealTimeValidation(true);
                });
            }
            
            async handleValidateAll() {
                try {
                    // リアルタイム検証を一時無効化（パフォーマンス向上）
                    this.toggleRealTimeValidation(false);
                    
                    const projectElements = this.elements.projectsList?.querySelectorAll('[data-project-index]');
                    const results = [];
                    
                    // プログレス表示
                    this.showValidationProgress(0, projectElements?.length || 0);
                    
                    // 順次検証実行
                    for (let i = 0; i < (projectElements?.length || 0); i++) {
                        const projectElement = projectElements[i];
                        const result = this.validator.validateProject(projectElement, this.projects[i]);
                        results.push({
                            ...result,
                            projectData: this.projects[i],
                            index: i
                        });
                        
                        // プログレス更新
                        this.showValidationProgress(i + 1, projectElements.length);
                        
                        // UIのブロッキングを防ぐための小さな遅延
                        if (i % 5 === 4) {
                            await new Promise(resolve => setTimeout(resolve, 10));
                        }
                    }
                    
                    this.displayOverallResults(results);
                    this.generateFormattedText(results);
                    
                    const okCount = results.filter(r => r.overallCheck).length;
                    this.notificationManager.showSuccess(`✅ 一括検証完了: ${okCount}/${results.length}件がOK`);
                    
                    // リアルタイム検証を再有効化
                    setTimeout(() => {
                        this.toggleRealTimeValidation(true);
                        this.forceRealTimeValidationAll();
                    }, 500);
                    
                } catch (error) {
                    this.notificationManager.showError('検証処理中にエラーが発生しました');
                    console.error('❌ 検証エラー:', error);
                } finally {
                    this.hideValidationProgress();
                }
            }
            
            showValidationProgress(current, total) {
                const progressContainer = this.elements.projectsList?.parentElement;
                if (!progressContainer) return;
                
                let progressDiv = progressContainer.querySelector('.validation-progress');
                if (!progressDiv) {
                    progressDiv = document.createElement('div');
                    progressDiv.className = 'validation-progress fixed top-4 left-1/2 transform -translate-x-1/2 bg-white border border-blue-300 rounded-lg p-4 shadow-lg z-50';
                    progressContainer.appendChild(progressDiv);
                }
                
                const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
                
                progressDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                        <div>
                            <div class="text-sm font-medium text-blue-700">検証実行中...</div>
                            <div class="text-xs text-gray-600">${current}/${total}件 (${percentage}%)</div>
                        </div>
                    </div>
                    <div class="mt-2 bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
                    </div>
                `;
                
                progressDiv.style.display = 'block';
            }
            
            hideValidationProgress() {
                const progressDiv = document.querySelector('.validation-progress');
                if (progressDiv) {
                    progressDiv.style.display = 'none';
                }
            }
            
            displayOverallResults(results) {
                const okCount = results.filter(r => r.overallCheck).length;
                const totalCount = results.length;
                
                const html = `
                    <div class="mb-6 p-4 rounded-lg ${okCount === totalCount ? 'bg-green-50 border border-green-200' : 'bg-yellow-50 border border-yellow-200'}">
                        <h4 class="font-semibold text-lg mb-2">検証サマリー</h4>
                        <p class="text-gray-700">全${totalCount}件中 <span class="font-semibold text-green-600">${okCount}件OK</span>、<span class="font-semibold text-red-600">${totalCount - okCount}件NG</span></p>
                        <div class="mt-2 bg-gray-200 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: ${(okCount/totalCount)*100}%"></div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        ${results.map((result, index) => {
                            const spec = result.projectData.basicInfo['仕様'] || '不明';
                            return `
                                <div class="flex justify-between items-center p-3 rounded-lg border ${result.overallCheck ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                                    <span class="font-medium">${index + 1}. ${spec}</span>
                                    <span class="px-3 py-1 rounded-full text-sm font-medium ${result.overallCheck ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${result.overallCheck ? '✓ OK' : '✗ NG'}
                                    </span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                if (this.elements.overallResultsContent) {
                    this.elements.overallResultsContent.innerHTML = html;
                }
                
                if (this.elements.overallResults) {
                    this.elements.overallResults.style.display = 'block';
                }
            }
            
            generateFormattedText(results) {
                const formatter = new TextFormatter();
                const formattedText = formatter.generateFormattedText(results);
                
                if (this.elements.formattedText) {
                    this.elements.formattedText.textContent = formattedText;
                }
                
                if (this.elements.formattedTextSection) {
                    this.elements.formattedTextSection.style.display = 'block';
                }
            }
            
            async copyToClipboard() {
                try {
                    const textToCopy = this.elements.formattedText?.textContent;
                    if (!textToCopy) {
                        throw new Error('コピーするテキストがありません');
                    }
                    
                    await navigator.clipboard.writeText(textToCopy);
                    this.notificationManager.showSuccess('クリップボードにコピーしました');
                } catch (error) {
                    this.notificationManager.showError('クリップボードへのコピーに失敗しました');
                    console.error('コピーエラー:', error);
                }
            }
            
            toggleProcessingState(isProcessing) {
                if (this.elements.processDataBtn) {
                    this.elements.processDataBtn.disabled = isProcessing;
                    this.elements.processDataBtn.textContent = isProcessing ? '処理中...' : 'データ処理';
                }
            }
            
            clearAll() {
                Object.values(this.elements).forEach(element => {
                    if (element?.tagName === 'TEXTAREA' || element?.tagName === 'INPUT') {
                        element.value = '';
                    }
                });
                
                this.projects = [];
                this.applicationDataMap.clear();
                
                ['projectsSection', 'overallResults', 'formattedTextSection'].forEach(id => {
                    if (this.elements[id]) {
                        this.elements[id].style.display = 'none';
                    }
                });
                
                this.elements.inputData?.focus();
                this.notificationManager.showSuccess('全てのデータをクリアしました');
            }
        }
        
        /**
         * データ解析クラス
         * 生データと申請データをパースして構造化データに変換する
         * @class DataParser
         */
        class DataParser {
            parseRawData(text) {
                const sections = text.split(/\n\s*\n/).filter(section => section.trim() !== '');
                const projects = [];
                
                for (let i = 0; i < sections.length; i++) {
                    const section = sections[i];
                    const lines = section.split('\n').map(line => line.trim()).filter(line => line !== '');
                    const basicInfo = this.parseDataSection(lines, i + 1);
                    
                    // より柔軟な条件で案件を判定
                    if (this.isValidProject(basicInfo)) {
                        projects.push({ basicInfo });
                        console.log(`📋 案件${projects.length}の解析結果:`, basicInfo);
                    } else {
                        console.warn(`⚠️ 案件${i + 1}のデータが不完全です:`, basicInfo);
                    }
                }
                
                return projects;
            }
            
            parseDataSection(lines, projectIndex) {
                const basicInfo = {};
                
                for (const line of lines) {
                    const parsedData = this.parseDataLine(line);
                    if (parsedData) {
                        Object.assign(basicInfo, parsedData);
                    }
                }
                
                // データ品質チェックとフォールバック処理
                return this.applyDataFallbacks(basicInfo, projectIndex);
            }
            
            parseDataLine(line) {
                // 複数の区切り文字パターンに対応
                const separators = [
                    /\t+/,           // タブ区切り
                    /\s{2,}/,        // 複数スペース
                    /[:：]\s*/,      // コロン区切り
                    /[　\s]+/        // 全角・半角スペース混在
                ];
                
                for (const separator of separators) {
                    const parts = line.split(separator);
                    if (parts.length >= 2) {
                        const key = parts[0].trim();
                        const value = parts.slice(1).join(' ').trim(); // 残り全部を結合
                        
                        if (key && value && key !== value) {
                            return { [key]: value };
                        }
                    }
                }
                
                // 特殊パターンの解析（項目名が含まれていない場合）
                return this.parseSpecialPatterns(line);
            }
            
            parseSpecialPatterns(line) {
                // 型番らしいパターン（英数字とハイフン等）
                if (/^[A-Za-z0-9\-_.]+$/.test(line) && line.length > 3) {
                    return { '型番': line };
                }

                // 価格パターン（加工費を含む）
                if (/¥?\d+(\.\d+)?円?/.test(line)) {
                    // 加工費のキーワードがある場合
                    if (/加工費|加工料|工賃|前回の注文加工費/.test(line)) {
                        return { '前回の注文加工費': line.replace(/.*?(\¥?\d+(\.\d+)?円?).*/, '$1') };
                    }
                    // それ以外は単価
                    return { '前回の注文単価': line };
                }

                // 数量パターン
                if (/^\d+個?$/.test(line)) {
                    const quantity = line.replace(/個?$/, '');
                    return { '年間使用数': quantity };
                }

                return null;
            }
            
            applyDataFallbacks(basicInfo, projectIndex) {
                // キーマッピング：生データのキー → 内部キー
                const keyMapping = {
                    '前回の注文加工費': '前回注文加工費',
                    '前回注文加工費': '前回注文加工費',
                    '加工費': '前回注文加工費'
                };

                // マッピングされたデータで基本情報を更新
                const mappedInfo = { ...basicInfo };
                Object.keys(keyMapping).forEach(sourceKey => {
                    if (basicInfo[sourceKey]) {
                        const targetKey = keyMapping[sourceKey];
                        mappedInfo[targetKey] = basicInfo[sourceKey];
                        console.log(`🔄 キーマッピング: "${sourceKey}" → "${targetKey}" (値: ${basicInfo[sourceKey]})`);
                        // 元のキーが異なる場合は削除
                        if (sourceKey !== targetKey) {
                            delete mappedInfo[sourceKey];
                        }
                    }
                });

                const fallbacks = {
                    '仕様': this.generateSpecFallback(mappedInfo, projectIndex),
                    '型番': mappedInfo['型番'] || `TYPE-${projectIndex}`,
                    '在庫数': mappedInfo['在庫数'] || '0',
                    '年間使用数': mappedInfo['年間使用数'] || '0',
                    '購買先': mappedInfo['購買先'] || '未指定',
                    '前回の注文単価': mappedInfo['前回の注文単価'] || '¥0',
                    '前回注文加工費': mappedInfo['前回注文加工費'] || '¥0'
                };
                
                // 既存データを優先し、不足分をフォールバックで補完
                return { ...fallbacks, ...mappedInfo };
            }
            
            generateSpecFallback(basicInfo, projectIndex) {
                // 既存の仕様（物品名）があればそれを使用
                if (basicInfo['仕様']) {
                    return basicInfo['仕様'];
                }
                
                // 型番から物品名を推定
                if (basicInfo['型番'] && !basicInfo['型番'].includes('TYPE-')) {
                    return `${basicInfo['型番']}`;
                }
                
                // 他のフィールドから推定
                const candidates = [
                    basicInfo['商品名'],
                    basicInfo['品名'],
                    basicInfo['製品名'],
                    basicInfo['部品名'],
                    basicInfo['物品名']
                ];
                
                for (const candidate of candidates) {
                    if (candidate) {
                        return candidate;
                    }
                }
                
                // 最終フォールバック
                return `物品${projectIndex}`;
            }
            
            isValidProject(basicInfo) {
                // より柔軟な判定条件
                const hasEssentialData = 
                    basicInfo['仕様'] || 
                    basicInfo['型番'] || 
                    basicInfo['年間使用数'] ||
                    basicInfo['商品名'] ||
                    basicInfo['品名'] ||
                    basicInfo['物品名'] ||
                    basicInfo['在庫数'];
                
                // 少なくとも1つの重要データがあれば有効
                return hasEssentialData;
            }
            
            parseApplicationData(text) {
                const lines = text.split('\n').map(line => line.trim()).filter(line => line !== '');
                const applicationMap = new Map();
                
                for (const line of lines) {
                    if (line.startsWith('http')) continue;
                    
                    // より柔軟なパターンマッチング
                    const patterns = [
                        /^(.+?)[:：]\s*@?(\d+(?:,\d{3})*)円?\s*\/\s*(\d+)個?/,  // 基本パターン
                        /^(.+?)\s+(\d+(?:,\d{3})*)円?\s*\/\s*(\d+)個?/,        // スペース区切り
                        /^(.+?)\s*@(\d+(?:,\d{3})*)\/(\d+)/                    // @区切り
                    ];
                    
                    for (const pattern of patterns) {
                        const match = line.match(pattern);
                        if (match) {
                            const [, spec, price, quantity] = match;
                            const cleanSpec = spec.trim();
                            applicationMap.set(cleanSpec, {
                                unitPrice: parseInt(price.replace(/,/g, '')),
                                quantity: parseInt(quantity)
                            });
                            console.log(`📊 申請データ解析: ${cleanSpec} -> 単価:${price}円, 数量:${quantity}個`);
                            break;
                        }
                    }
                }
                
                console.log(`✅ 申請データ解析完了: ${applicationMap.size}件`);
                return applicationMap;
            }
        }
        
        /**
         * プロジェクト検証クラス
         * 案件データの各種検証（注文数、価格、型番、図番、加工費）を実行
         * @class ProjectValidator
         */
        class ProjectValidator {
            validateProject(projectElement, projectData) {
                const formData = this.extractFormData(projectElement);
                const checks = this.performValidationChecks(formData, projectData);
                
                this.displayProjectValidationResult(projectElement, checks, projectData);
                return checks;
            }
            
            extractFormData(projectElement) {
                return {
                    orderQuantity: parseInt(projectElement.querySelector('.order-quantity')?.value) || 0,
                    applicationPrice: projectElement.querySelector('.application-price')?.value || '',
                    totalAmount: projectElement.querySelector('.total-amount')?.value || '',
                    taxIncluded: projectElement.querySelector('.tax-included')?.checked || false,
                    zaicoModel: projectElement.querySelector('.zaico-model')?.value?.trim() || '',
                    supplierModel: projectElement.querySelector('.supplier-model')?.value?.trim() || '',
                    zaicoDrawingNo: projectElement.querySelector('.zaico-drawing-no')?.value?.trim() || '',
                    supplierDrawingNo: projectElement.querySelector('.supplier-drawing-no')?.value?.trim() || '',
                    isBestPrice: projectElement.querySelector('.best-price')?.checked || false,
                    hasSpecialReason: projectElement.querySelector('.special-reason')?.checked || false,
                    specialReasonDetail: projectElement.querySelector('.special-reason-detail')?.value?.trim() || '',
                    hasSpecialAdoption: projectElement.querySelector('.special-adoption')?.checked || false,
                    specialAdoptionDetail: projectElement.querySelector('.special-adoption-detail')?.value?.trim() || '',
                    hasSpecMatchConfirmed: projectElement.querySelector('.spec-match-confirmed')?.checked || false,
                    hasModelException: projectElement.querySelector('.model-exception')?.checked || false,
                    modelExceptionDetail: projectElement.querySelector('.model-exception-detail')?.value?.trim() || '',
                    hasNoDrawingNumber: projectElement.querySelector('.no-drawing-number')?.checked || false,
                    hasDrawingException: projectElement.querySelector('.drawing-exception')?.checked || false,
                    drawingExceptionDetail: projectElement.querySelector('.drawing-exception-detail')?.value?.trim() || '',
                    hasProcessingFeeComparison: projectElement.querySelector('.processing-fee-comparison')?.checked || false,
                    hasProcessingFeeIncrease: projectElement.querySelector('.processing-fee-increase')?.checked || false,
                    processingFeeIncreaseDetail: projectElement.querySelector('.processing-fee-increase-detail')?.value?.trim() || ''
                };
            }
            
            performValidationChecks(formData, projectData) {
                const annualUsage = parseInt(projectData.basicInfo['年間使用数']) || 0;
                const previousPriceStr = projectData.basicInfo['前回の注文単価'] || '¥0';
                const previousPrice = parseFloat(previousPriceStr.replace(/[¥,\s]/g, ''));
                
                // 注文数検証
                const isInNormalRange = formData.orderQuantity >= annualUsage / 2 && formData.orderQuantity <= annualUsage;
                const orderCheck = isInNormalRange || (formData.hasSpecialReason && formData.specialReasonDetail !== '');
                
                // 価格検証
                const calculatedPrice = this.calculateUnitPrice(formData.totalAmount, formData.orderQuantity, formData.taxIncluded);
                const priceCheck = this.validatePrice(calculatedPrice, previousPrice, formData);
                
                // 型番検証
                const modelCheck = this.validateModel(formData);
                
                // 図番検証
                const drawingCheck = this.validateDrawing(formData);
                
                // 加工費検証
                const processingFeeCheck = this.validateProcessingFee(formData, projectData);

                // 加工費比較の詳細情報を取得
                const processingFeeDetails = this.getProcessingFeeComparisonDetails(formData, projectData);

                // 申請単価との一致チェック
                const appliedPrice = parseFloat(formData.applicationPrice.replace(/[¥,\s]/g, ''));
                const unitPriceMatch = Math.abs(appliedPrice - calculatedPrice) < 0.01;

                return {
                    orderCheck,
                    priceCheck,
                    modelCheck,
                    drawingCheck,
                    processingFeeCheck,
                    unitPriceMatch,
                    overallCheck: orderCheck && priceCheck && modelCheck && drawingCheck && processingFeeCheck && unitPriceMatch,
                    calculatedPrice: calculatedPrice.toFixed(2),
                    processingFeeDetails,
                    ...formData
                };
            }
            
            calculateUnitPrice(totalAmount, quantity, taxIncluded = false) {
                if (!totalAmount || !quantity || quantity <= 0) return 0;
                
                const total = parseFloat(totalAmount.replace(/[¥,\s]/g, '')) || 0;
                let unitPrice = 0;
                
                if (taxIncluded) {
                    // 税込の場合: 税込 - (税込/11)、小数第3位で切り捨て
                    const taxAmount = total / 11;
                    const totalWithoutTax = total - taxAmount;
                    unitPrice = totalWithoutTax / quantity;
                    
                    // 小数第3位で切り捨て (Math.floor(value * 100) / 100)
                    unitPrice = Math.floor(unitPrice * 100) / 100;
                } else {
                    // 税抜の場合: 通常の計算
                    unitPrice = total / quantity;
                    unitPrice = Math.floor(unitPrice * 100) / 100;
                }
                
                return unitPrice;
            }
            
            validatePrice(calculatedPrice, previousPrice, formData) {
                if (calculatedPrice <= previousPrice) return true;
                if (calculatedPrice > previousPrice && formData.isBestPrice) return true;
                if (calculatedPrice > previousPrice && formData.hasSpecialAdoption && formData.specialAdoptionDetail !== '') return true;
                return false;
            }
            
            validateModel(formData) {
                // 仕様一致確認がチェック済みの場合はOK
                if (formData.hasSpecMatchConfirmed) {
                    return true;
                }

                const modelsMatch = formData.zaicoModel !== '' && formData.supplierModel !== '' &&
                                 formData.zaicoModel.replace(/\s/g, '') === formData.supplierModel.replace(/\s/g, '');
                const hasException = formData.hasModelException && formData.modelExceptionDetail !== '';

                return modelsMatch || hasException;
            }
            
            validateDrawing(formData) {
                // 図番なしの場合はOK
                if (formData.hasNoDrawingNumber) {
                    return true;
                }
                
                // 図番が一致している場合はOK
                const drawingsMatch = formData.zaicoDrawingNo !== '' && formData.supplierDrawingNo !== '' && 
                                    formData.zaicoDrawingNo.replace(/\s/g, '') === formData.supplierDrawingNo.replace(/\s/g, '');
                
                // 図番不一致の特別事情がある場合はOK
                const hasException = formData.hasDrawingException && formData.drawingExceptionDetail !== '';
                
                return drawingsMatch || hasException;
            }
            
            validateProcessingFee(formData, projectData) {
                // 加工費比較チェックボックスがチェックされていない場合はOK（比較しない）
                if (!formData.hasProcessingFeeComparison) {
                    return true;
                }

                // 申請単価を取得
                const applicationPrice = parseFloat(formData.applicationPrice.replace(/[¥,\s]/g, ''));
                if (!applicationPrice || applicationPrice === 0) {
                    return false;
                }

                // 前回注文加工費を取得
                const previousProcessingFeeStr = projectData.basicInfo['前回注文加工費'] || '¥0';
                const previousProcessingFee = parseFloat(previousProcessingFeeStr.replace(/[¥,\s]/g, ''));

                // 申請単価が前回注文加工費以下の場合はOK
                if (applicationPrice <= previousProcessingFee) {
                    return true;
                }

                // 申請単価が前回注文加工費より高い場合は、特別事情の記載があればOK
                if (applicationPrice > previousProcessingFee && formData.hasProcessingFeeIncrease && formData.processingFeeIncreaseDetail !== '') {
                    return true;
                }

                // それ以外はNG
                return false;
            }

            // 加工費比較の詳細情報を取得する新しいメソッド（前回注文加工費 vs 申請単価）
            getProcessingFeeComparisonDetails(formData, projectData) {
                if (!formData.hasProcessingFeeComparison) {
                    return null;
                }

                const previousProcessingFeeStr = projectData.basicInfo['前回注文加工費'] || '¥0';
                const previousProcessingFee = parseFloat(previousProcessingFeeStr.replace(/[¥,\s]/g, ''));
                const applicationPrice = parseFloat((formData.applicationPrice || '0').replace(/[¥,\s]/g, ''));

                const difference = applicationPrice - previousProcessingFee;
                const percentageChange = previousProcessingFee > 0 ? (difference / previousProcessingFee) * 100 : 0;

                return {
                    previousFee: previousProcessingFee,
                    currentFee: applicationPrice,
                    difference: difference,
                    percentageChange: percentageChange,
                    isIncrease: difference > 0,
                    isDecrease: difference < 0,
                    isSame: difference === 0,
                    hasIncreasedWithReason: difference > 0 && formData.hasProcessingFeeIncrease && formData.processingFeeIncreaseDetail
                };
            }
            
            displayProjectValidationResult(projectElement, result, projectData) {
                const resultDiv = projectElement.querySelector('.validation-result');
                const statusDiv = projectElement.querySelector('.validation-status');
                
                if (statusDiv) {
                    statusDiv.style.display = 'inline-block';
                    statusDiv.className = `validation-status px-3 py-1 rounded-full text-sm font-medium ${result.overallCheck ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                    statusDiv.textContent = result.overallCheck ? '✓ OK' : '✗ NG';
                }
                
                if (resultDiv) {
                    resultDiv.innerHTML = this.generateResultHTML(result, projectData);
                    resultDiv.style.display = 'block';
                }
            }
            
            generateResultHTML(result, projectData) {
                const taxLabel = result.taxIncluded ? '（税込計算）' : '（税抜計算）';
                const stockQuantity = projectData.basicInfo['在庫数'] || '0';
                
                return `
                    <div class="flex justify-between items-center mb-3">
                        <h5 class="font-semibold">検証結果詳細</h5>
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${result.overallCheck ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${result.overallCheck ? '✓ OK' : '✗ NG'}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2 text-sm mb-3">
                        ${['orderCheck', 'priceCheck', 'modelCheck', 'drawingCheck', 'processingFeeCheck', 'unitPriceMatch'].map(check => {
                            const labels = {
                                orderCheck: '注文数',
                                priceCheck: '価格',
                                modelCheck: '型番',
                                drawingCheck: '図番',
                                processingFeeCheck: '加工費',
                                unitPriceMatch: '単価一致'
                            };
                            return `
                                <div class="flex items-center ${result[check] ? 'text-green-600' : 'text-red-600'}">
                                    <span class="mr-1">${result[check] ? '✓' : '✗'}</span>
                                    <strong>${labels[check]}</strong>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded">
                        <div class="flex items-center mb-1">
                            <span class="mr-2">${result.taxIncluded ? '💰' : '💡'}</span>
                            <strong>計算単価: ¥${result.calculatedPrice} ${taxLabel}</strong>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
                            <div>前回注文単価: ${projectData.basicInfo['前回の注文単価']}</div>
                            <div>注文数: ${result.orderQuantity}個</div>
                            <div>年間使用数: ${projectData.basicInfo['年間使用数']}個</div>
                            <div>在庫数: ${stockQuantity}個</div>
                            <div>前回注文加工費: ${projectData.basicInfo['前回注文加工費'] || '¥0'}</div>
                        </div>
                        ${this.generateProcessingFeeComparisonHTML(result, projectData)}
                        ${result.taxIncluded ? '<div class="text-xs text-green-700 mt-2">※ 税込金額から税抜単価を自動計算（小数第3位切り捨て）</div>' : ''}
                    </div>
                `;
            }

            // 加工費比較の詳細表示HTML生成
            generateProcessingFeeComparisonHTML(result, projectData) {
                if (!result.processingFeeDetails) {
                    return '';
                }

                const details = result.processingFeeDetails;
                const formatPrice = (price) => `¥${price.toLocaleString()}`;

                let comparisonText = '';
                let comparisonColor = '';
                let icon = '';

                if (details.isSame) {
                    comparisonText = '前回と同額';
                    comparisonColor = 'text-blue-600';
                    icon = '🟰';
                } else if (details.isDecrease) {
                    const saving = Math.abs(details.difference);
                    const savingPercent = Math.abs(details.percentageChange).toFixed(1);
                    comparisonText = `${formatPrice(saving)}削減 (${savingPercent}%↓)`;
                    comparisonColor = 'text-green-600';
                    icon = '📉';
                } else if (details.isIncrease) {
                    const increase = details.difference;
                    const increasePercent = details.percentageChange.toFixed(1);
                    comparisonText = `${formatPrice(increase)}上昇 (${increasePercent}%↑)`;
                    comparisonColor = details.hasIncreasedWithReason ? 'text-orange-600' : 'text-red-600';
                    icon = details.hasIncreasedWithReason ? '📈' : '⚠️';
                }

                return `
                    <div class="mt-3 p-2 border-t border-gray-200">
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-500">🔧 加工費比較</span>
                            <span class="${comparisonColor} text-xs font-medium">
                                ${icon} ${comparisonText}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-1 text-xs">
                            <div>前回注文加工費: ${formatPrice(details.previousFee)}</div>
                            <div>申請単価: ${formatPrice(details.currentFee)}</div>
                        </div>
                        ${details.hasIncreasedWithReason ? `
                            <div class="mt-1 text-xs text-orange-600">
                                ✓ 上昇理由記載済み
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        }
        
        /**
         * UI生成クラス
         * 案件データから動的にHTMLを生成しUIを構築
         * @class UIGenerator
         */
        class UIGenerator {
            generateProjectHTML(project, index, applicationDataMap) {
                const basicInfo = project.basicInfo;
                const projectTitle = this.generateProjectTitle(basicInfo, index);
                const application = this.findMatchingApplication(basicInfo, applicationDataMap);
                
                return `
                    <div class="border rounded-lg p-6 bg-gray-50 hover:bg-gray-100 transition-colors" data-project-index="${index}">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h4 class="font-semibold text-lg text-gray-800 mb-1">${index + 1}. ${projectTitle.main}</h4>
                                ${projectTitle.sub ? `<p class="text-sm text-gray-600">${projectTitle.sub}</p>` : ''}
                            </div>
                            <div class="validation-status px-3 py-1 rounded-full text-sm font-medium" style="display: none;"></div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            ${this.generateBasicInfoSection(basicInfo)}
                            ${this.generateValidationInputSection(application)}
                        </div>
                        
                        <div class="validation-result mt-6 p-4 rounded-lg bg-white border" style="display: none;"></div>
                    </div>
                `;
            }
            
            generateProjectTitle(basicInfo, index) {
                // 題目の決定：型番 → 物品名の順で優先
                let mainTitle = '';
                let subTitle = '';
                
                // 優先順位：型番 → 物品名（仕様）
                if (basicInfo['型番'] && basicInfo['型番'] !== '未指定' && !basicInfo['型番'].includes('TYPE-')) {
                    mainTitle = basicInfo['型番'];
                    // サブタイトルに物品名を表示
                    if (basicInfo['仕様'] && basicInfo['仕様'] !== mainTitle && !basicInfo['仕様'].includes('案件')) {
                        subTitle = `物品名: ${basicInfo['仕様']}`;
                    }
                } else if (basicInfo['仕様'] && !basicInfo['仕様'].includes('案件')) {
                    mainTitle = basicInfo['仕様'];
                    // サブタイトルに購買先を表示
                    if (basicInfo['購買先'] && basicInfo['購買先'] !== '未指定') {
                        subTitle = `購買先: ${basicInfo['購買先']}`;
                    }
                } else {
                    // フォールバック
                    mainTitle = `案件${index + 1}`;
                    if (basicInfo['購買先'] && basicInfo['購買先'] !== '未指定') {
                        subTitle = `購買先: ${basicInfo['購買先']}`;
                    }
                }
                
                return {
                    main: mainTitle,
                    sub: subTitle
                };
            }
            
            generateBasicInfoSection(basicInfo) {
                const fields = [
                    { label: '物品名', key: '仕様', icon: '📦', required: true },
                    { label: '型番', key: '型番', icon: '🔢', required: true },
                    { label: '在庫数', key: '在庫数', icon: '📊', required: false, type: 'number' },
                    { label: '年間使用数', key: '年間使用数', icon: '📈', required: true, type: 'number' },
                    { label: '購買先', key: '購買先', icon: '🏢', required: false },
                    { label: '前回注文単価', key: '前回の注文単価', icon: '💰', required: true },
                    { label: '前回注文加工費', key: '前回注文加工費', icon: '🔧', required: false }
                ];
                
                return `
                    <div class="space-y-3">
                        <div class="flex justify-between items-center border-b pb-2">
                            <h5 class="font-semibold text-gray-700">📄 基本情報</h5>
                            <button class="edit-basic-info-btn text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors">
                                ✏️ 編集
                            </button>
                        </div>
                        
                        <div class="basic-info-display space-y-2">
                            ${fields.map(field => {
                                const value = this.formatFieldValue(basicInfo[field.key], field.key);
                                const isEmpty = !basicInfo[field.key] || basicInfo[field.key] === '未指定' || basicInfo[field.key] === '0';
                                const isAutoGenerated = basicInfo[field.key] && (basicInfo[field.key].includes('案件') || basicInfo[field.key].includes('TYPE-') || basicInfo[field.key].includes('物品'));
                                
                                return `
                                    <div class="flex items-start ${isEmpty || isAutoGenerated ? 'opacity-60' : ''}">
                                        <span class="mr-2">${field.icon}</span>
                                        <strong class="text-gray-600 min-w-[120px] text-sm ${field.required ? 'after:content-["*"] after:text-red-500' : ''}">${field.label}:</strong>
                                        <span class="text-gray-800 ml-2 text-sm flex-1 ${isEmpty ? 'italic' : ''} ${isAutoGenerated ? 'text-orange-600' : ''}">${value}</span>
                                        ${isAutoGenerated ? '<span class="ml-1 text-xs text-orange-500">自動生成</span>' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="basic-info-edit space-y-3" style="display: none;">
                            ${fields.map(field => {
                                const value = basicInfo[field.key] || '';
                                const displayValue = (value === '未指定' || value.includes('案件') || value.includes('TYPE-') || value.includes('物品')) ? '' : value;
                                const cleanValue = displayValue.replace(/¥|円|個\/年|個/g, '');
                                
                                return `
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            ${field.icon} ${field.label}${field.required ? ' <span class="text-red-500">*</span>' : ''}
                                        </label>
                                        <input
                                            type="${field.type || 'text'}"
                                            class="basic-info-input w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-sm"
                                            data-field="${field.key}"
                                            value="${cleanValue}"
                                            placeholder="${this.getFieldPlaceholder(field.key)}"
                                            ${field.required ? 'required' : ''}
                                        />
                                        ${field.key === '年間使用数' ? '<p class="text-xs text-gray-500 mt-1">半年〜1年分の注文数計算に使用</p>' : ''}
                                        ${field.key === '前回の注文単価' ? '<p class="text-xs text-gray-500 mt-1">価格比較の基準値</p>' : ''}
                                    </div>
                                `;
                            }).join('')}
                            
                            <div class="flex space-x-2 pt-2 border-t">
                                <button class="save-basic-info-btn px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition-colors">
                                    💾 保存
                                </button>
                                <button class="cancel-basic-info-btn px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600 transition-colors">
                                    ❌ キャンセル
                                </button>
                                <button class="reset-basic-info-btn px-3 py-1 bg-orange-500 text-white rounded text-sm hover:bg-orange-600 transition-colors">
                                    🔄 元に戻す
                                </button>
                            </div>
                        </div>
                        
                        <!-- データ品質インジケーター -->
                        <div class="mt-3 pt-2 border-t">
                            ${this.generateDataQualityIndicator(basicInfo)}
                        </div>
                    </div>
                `;
            }
            
            getFieldPlaceholder(fieldKey) {
                const placeholders = {
                    '仕様': '物品名を入力（例：ボルト、ナット等）',
                    '型番': '型番を入力（例：ABC-123）',
                    '在庫数': '現在の在庫数',
                    '年間使用数': '年間の使用個数',
                    '購買先': '購買先名を入力',
                    '前回の注文単価': '前回の単価（例：1500）',
                    '前回注文加工費': '前回の加工費（例：500）'
                };
                return placeholders[fieldKey] || '';
            }
            
            formatFieldValue(value, fieldKey) {
                if (!value || value === '未指定') {
                    switch (fieldKey) {
                        case '仕様':
                            return '物品名未設定';
                        case '型番':
                            return '型番未登録';
                        case '在庫数':
                            return '在庫数未設定';
                        case '年間使用数':
                            return '使用数未設定';
                        case '購買先':
                            return '購買先未指定';
                        case '前回の注文単価':
                            return '単価情報なし';
                        case '前回注文加工費':
                            return '加工費情報なし';
                        default:
                            return '情報なし';
                    }
                }
                
                // 数値フィールドの場合の特別処理
                if (fieldKey === '年間使用数' && value !== '0') {
                    return `${value}個/年`;
                }
                
                if (fieldKey === '在庫数' && value !== '0') {
                    return `${value}個`;
                }
                
                return value;
            }
            
            generateDataQualityIndicator(basicInfo) {
                const requiredFields = ['仕様', '型番', '在庫数', '年間使用数', '前回の注文単価'];
                const filledFields = requiredFields.filter(field => 
                    basicInfo[field] && 
                    basicInfo[field] !== '未指定' && 
                    basicInfo[field] !== '0' && 
                    !basicInfo[field].includes('案件') &&
                    !basicInfo[field].includes('TYPE-')
                );
                
                const completeness = (filledFields.length / requiredFields.length) * 100;
                
                let indicator = '';
                let bgColor = '';
                
                if (completeness >= 80) {
                    indicator = '🟢 データ充実';
                    bgColor = 'bg-green-50 border-green-200 text-green-700';
                } else if (completeness >= 60) {
                    indicator = '🟡 データ不足';
                    bgColor = 'bg-yellow-50 border-yellow-200 text-yellow-700';
                } else {
                    indicator = '🔴 データ不備';
                    bgColor = 'bg-red-50 border-red-200 text-red-700';
                }
                
                return `
                    <div class="text-xs p-2 rounded border ${bgColor}">
                        <div class="flex justify-between items-center">
                            <span>${indicator}</span>
                            <span>${filledFields.length}/${requiredFields.length}項目</span>
                        </div>
                        <div class="mt-1 bg-gray-200 rounded-full h-1">
                            <div class="h-1 rounded-full transition-all duration-300" style="width: ${completeness}%; background-color: ${completeness >= 80 ? '#10b981' : completeness >= 60 ? '#f59e0b' : '#ef4444'}"></div>
                        </div>
                    </div>
                `;
            }
            
            generateValidationInputSection(application) {
                return `
                    <div class="space-y-4">
                        <h5 class="font-semibold text-gray-700 border-b pb-2">検証データ入力</h5>
                        
                        ${this.generateOrderQuantitySection(application)}
                        ${this.generatePriceSection(application)}
                        ${this.generateModelSection()}
                    </div>
                `;
            }
            
            generateOrderQuantitySection(application) {
                return `
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        ${this.generateInputField('注文数', 'number', 'order-quantity', application?.quantity || '', '年間使用数の半年～1年分')}
                        
                        <!-- 注文数関連チェックボックス -->
                        <div class="mt-3">
                            <label class="inline-flex items-center">
                                <input type="checkbox" class="special-reason rounded text-blue-600 focus:ring-blue-500" />
                                <span class="ml-2 text-sm text-gray-700">特別な理由（注文数が範囲外の場合）</span>
                            </label>
                            
                            <div class="special-reason-text mt-2" style="display: none;">
                                <textarea
                                    class="special-reason-detail w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-sm"
                                    rows="2"
                                    placeholder="注文数が年間使用数の範囲外である特別な理由を記載してください"
                                ></textarea>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            generatePriceSection(application) {
                return `
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        ${this.generateInputField('申請単価', 'text', 'application-price', application ? '¥' + application.unitPrice : '', '')}
                        
                        <div class="space-y-3">
                            ${this.generateInputField('商品総額', 'text', 'total-amount', application ? '¥' + (application.unitPrice * application.quantity) : '', '')}
                            
                            <!-- 税込/税抜チェックボックス -->
                            <div class="bg-white p-3 rounded border border-green-300">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="tax-included rounded text-green-600 focus:ring-green-500" />
                                    <span class="ml-2 text-sm font-medium text-gray-700">💰 商品総額は税込金額</span>
                                </label>
                                <p class="text-xs text-gray-600 mt-1 ml-6">
                                    ✓ チェック時: 税込金額から税抜単価を計算<br>
                                    ✗ 未チェック: 税抜金額として単価を計算
                                </p>
                            </div>
                        </div>
                        
                        <div class="calculation-display mt-3 text-sm bg-white p-3 rounded border border-green-300" style="display: none;"></div>
                        
                        <!-- 価格関連チェックボックス -->
                        <div class="mt-4 space-y-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" class="best-price rounded text-green-600 focus:ring-green-500" />
                                <span class="ml-2 text-sm text-gray-700">📊 相見積もりで最安値</span>
                            </label>
                            
                            <label class="inline-flex items-center">
                                <input type="checkbox" class="special-adoption rounded text-green-600 focus:ring-green-500" />
                                <span class="ml-2 text-sm text-gray-700">⚠️ 特別採用（価格上昇の特別事情）</span>
                            </label>
                            
                            <div class="special-adoption-text mt-2" style="display: none;">
                                <textarea
                                    class="special-adoption-detail w-full p-2 border rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors text-sm"
                                    rows="2"
                                    placeholder="価格上昇の特別事情・理由を詳しく記載してください"
                                ></textarea>
                            </div>
                            
                            <!-- 加工費比較チェックボックス -->
                            <div class="border border-green-200 rounded-lg p-3 bg-green-50">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="processing-fee-comparison rounded text-green-600 focus:ring-green-500" />
                                    <span class="ml-2 text-sm font-medium text-green-700">🔧 加工費比較を有効にする</span>
                                </label>
                                <p class="text-xs text-green-600 mt-1 ml-6">
                                    前回注文加工費と申請単価を自動比較し、申請単価が上昇時は理由記載が必要です
                                </p>
                            </div>
                            
                            <div class="processing-fee-section mt-2" style="display: none;">
                                <div class="bg-white p-3 rounded border border-green-300">
                                    <div class="mb-3">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">前回注文加工費</label>
                                                <div class="p-2 bg-gray-100 border rounded-md text-sm text-gray-600 processing-fee-previous">
                                                    データから自動取得
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">申請単価</label>
                                                <div class="p-2 bg-blue-100 border rounded-md text-sm text-blue-700 application-price-display">
                                                    申請単価を自動使用
                                                </div>
                                            </div>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-2">
                                            ※ 申請単価（上記入力済み）と前回注文加工費を自動比較します
                                        </p>
                                    </div>
                                    
                                    <div class="mt-2">
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" class="processing-fee-increase rounded text-green-600 focus:ring-green-500" />
                                            <span class="ml-2 text-sm text-gray-700">申請単価上昇の特別事情</span>
                                        </label>
                                        
                                        <div class="processing-fee-increase-text mt-2" style="display: none;">
                                            <textarea
                                                class="processing-fee-increase-detail w-full p-2 border rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors text-sm"
                                                rows="2"
                                                placeholder="申請単価が前回注文加工費より上昇した理由を詳しく記載してください"
                                            ></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            generateModelSection() {
                return `
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <!-- 型番チェック -->
                        <div>
                            <h6 class="font-medium text-purple-700 mb-3">🔢 型番チェック</h6>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ZAICO型番</label>
                                    <input
                                        type="text"
                                        class="zaico-model w-full p-3 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        placeholder="ZAICO型番"
                                        value=""
                                    />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">購買先型番</label>
                                    <input
                                        type="text"
                                        class="supplier-model w-full p-3 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        placeholder="購買先型番"
                                        value=""
                                    />
                                </div>
                            </div>
                            
                            <!-- 型番関連チェックボックス -->
                            <div class="space-y-2">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="spec-match-confirmed rounded text-purple-600 focus:ring-purple-500" />
                                    <span class="ml-2 text-sm text-gray-700">仕様一致確認済み</span>
                                </label>

                                <div>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="model-exception rounded text-purple-600 focus:ring-purple-500" />
                                        <span class="ml-2 text-sm text-gray-700">型番不一致の特別事情</span>
                                    </label>

                                    <div class="model-exception-text mt-2" style="display: none;">
                                        <textarea
                                            class="model-exception-detail w-full p-2 border rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors text-sm"
                                            rows="2"
                                            placeholder="型番が不一致である理由を詳しく記載してください"
                                        ></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 図番チェック -->
                        <div class="mt-6 pt-4 border-t border-purple-200">
                            <h6 class="font-medium text-purple-700 mb-3">📐 図番チェック</h6>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ZAICO図番</label>
                                    <input
                                        type="text"
                                        class="zaico-drawing-no w-full p-3 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        placeholder="ZAICO図番"
                                        value=""
                                    />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">購買先図番</label>
                                    <input
                                        type="text"
                                        class="supplier-drawing-no w-full p-3 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        placeholder="購買先図番"
                                        value=""
                                    />
                                </div>
                            </div>
                            
                            <!-- 図番関連チェックボックス -->
                            <div class="space-y-2">
                                <div>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="no-drawing-number rounded text-purple-600 focus:ring-purple-500" />
                                        <span class="ml-2 text-sm text-gray-700">📝 図番なし</span>
                                    </label>
                                </div>
                                
                                <div>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="drawing-exception rounded text-purple-600 focus:ring-purple-500" />
                                        <span class="ml-2 text-sm text-gray-700">図番不一致の特別事情</span>
                                    </label>
                                    
                                    <div class="drawing-exception-text mt-2" style="display: none;">
                                        <textarea
                                            class="drawing-exception-detail w-full p-2 border rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors text-sm"
                                            rows="2"
                                            placeholder="図番が不一致である理由を詳しく記載してください"
                                        ></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            generateInputField(label, type, className, value, hint) {
                return `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                        <input
                            type="${type}"
                            class="${className} w-full p-3 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                            placeholder="${label}"
                            value="${value}"
                        />
                        ${hint ? `<p class="text-xs text-gray-500 mt-1">${hint}</p>` : ''}
                    </div>
                `;
            }
            
            findMatchingApplication(basicInfo, applicationDataMap) {
                // 検索キーの優先順位：型番 → 物品名（仕様） → その他
                const searchKeys = [
                    basicInfo['型番'],
                    basicInfo['仕様'],  // 物品名
                    basicInfo['商品名'],
                    basicInfo['品名'],
                    basicInfo['製品名'],
                    basicInfo['物品名']
                ].filter(key => key && key !== '未指定' && !key.includes('案件') && !key.includes('TYPE-') && !key.includes('物品'));
                
                // 直接マッチング
                for (const key of searchKeys) {
                    if (applicationDataMap.has(key)) {
                        console.log(`🎯 直接マッチング成功: ${key}`);
                        return applicationDataMap.get(key);
                    }
                }
                
                // 正規化マッチング
                const normalizeSpec = (specStr) => {
                    return specStr.toLowerCase()
                        .replace(/sq/g, '')
                        .replace(/\s+/g, '')
                        .replace(/\([^)]*\)/g, '')  // 括弧内を削除
                        .replace(/[　\s]/g, '')     // 全角スペースも削除
                        .replace(/[-.]/g, '');      // ハイフン、ドット削除
                };
                
                for (const searchKey of searchKeys) {
                    const normalizedSearchKey = normalizeSpec(searchKey);
                    
                    for (const [appKey, appValue] of applicationDataMap) {
                        const normalizedAppKey = normalizeSpec(appKey);
                        if (normalizedSearchKey === normalizedAppKey) {
                            console.log(`🎯 正規化マッチング成功: "${searchKey}" ≈ "${appKey}"`);
                            return appValue;
                        }
                    }
                }
                
                // 部分マッチング（型番と物品名のみ）
                const primaryKeys = [basicInfo['型番'], basicInfo['仕様']].filter(key => 
                    key && key !== '未指定' && !key.includes('案件') && !key.includes('TYPE-') && !key.includes('物品')
                );
                
                for (const searchKey of primaryKeys) {
                    for (const [appKey, appValue] of applicationDataMap) {
                        if (searchKey.includes(appKey) || appKey.includes(searchKey)) {
                            console.log(`🎯 部分マッチング成功: "${searchKey}" ∋∈ "${appKey}"`);
                            return appValue;
                        }
                    }
                }
                
                console.log(`❌ マッチング失敗: 検索キー[${searchKeys.join(', ')}]`);
                return null;
            }
        }
        
        /**
         * プロジェクトイベントハンドラークラス
         * 各案件の入力フィールドのイベント処理とリアルタイム検証を管理
         * @class ProjectEventHandler
         */
        class ProjectEventHandler {
            constructor(projectElement, validator) {
                this.projectElement = projectElement;
                this.validator = validator;
                this.debounceTimer = null;
                this.validationCache = new Map();
                this.isRealTimeEnabled = true;
            }
            
            setup() {
                this.setupPriceFormatting();
                this.setupCalculationUpdates();
                this.setupTaxIncludedToggle();
                this.setupCheckboxToggles();
                this.setupRealTimeValidation();
                this.setupVisualFeedback();
                this.setupBasicInfoEditing();
            }
            
            setupBasicInfoEditing() {
                const editBtn = this.projectElement.querySelector('.edit-basic-info-btn');
                const saveBtn = this.projectElement.querySelector('.save-basic-info-btn');
                const cancelBtn = this.projectElement.querySelector('.cancel-basic-info-btn');
                const resetBtn = this.projectElement.querySelector('.reset-basic-info-btn');
                
                const displaySection = this.projectElement.querySelector('.basic-info-display');
                const editSection = this.projectElement.querySelector('.basic-info-edit');
                
                // 元のデータを保存
                let originalData = this.getCurrentBasicInfo();
                
                editBtn?.addEventListener('click', () => {
                    originalData = this.getCurrentBasicInfo(); // 編集開始時の状態を保存
                    this.showEditMode(displaySection, editSection, editBtn);
                });
                
                saveBtn?.addEventListener('click', () => {
                    if (this.saveBasicInfo()) {
                        this.showDisplayMode(displaySection, editSection, editBtn);
                        this.triggerRealTimeValidation(true); // 保存後に検証実行
                        this.updateProjectTitle(); // タイトル更新
                        this.showNotification('基本情報を保存しました', 'success');
                    }
                });
                
                cancelBtn?.addEventListener('click', () => {
                    this.restoreBasicInfo(originalData);
                    this.showDisplayMode(displaySection, editSection, editBtn);
                });
                
                resetBtn?.addEventListener('click', () => {
                    if (confirm('元のデータに戻しますか？編集内容は失われます。')) {
                        this.resetToOriginalData();
                        this.showDisplayMode(displaySection, editSection, editBtn);
                        this.triggerRealTimeValidation(true);
                        this.updateProjectTitle();
                        this.showNotification('元のデータに戻しました', 'info');
                    }
                });
                
                // 基本情報の入力フィールドも監視対象に追加
                const basicInfoInputs = this.projectElement.querySelectorAll('.basic-info-input');
                basicInfoInputs.forEach(input => {
                    input.addEventListener('input', () => {
                        this.validateBasicInfoInput(input);
                        this.updateDataQualityIndicator();
                    });
                    
                    input.addEventListener('blur', () => {
                        this.formatBasicInfoInput(input);
                    });
                });
            }
            
            getCurrentBasicInfo() {
                const projectIndex = parseInt(this.projectElement.dataset.projectIndex);
                return window.DataFormatterApp?.projects?.[projectIndex]?.basicInfo || {};
            }
            
            showEditMode(displaySection, editSection, editBtn) {
                displaySection.style.display = 'none';
                editSection.style.display = 'block';
                editBtn.textContent = '📝 編集中';
                editBtn.disabled = true;
                editBtn.classList.add('opacity-50', 'cursor-not-allowed');
                
                // プロジェクト全体に編集中の視覚的フィードバック
                this.projectElement.classList.add('ring-2', 'ring-blue-300', 'bg-blue-50');
            }
            
            showDisplayMode(displaySection, editSection, editBtn) {
                displaySection.style.display = 'block';
                editSection.style.display = 'none';
                editBtn.textContent = '✏️ 編集';
                editBtn.disabled = false;
                editBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                
                // 編集中の視覚的フィードバックを削除
                this.projectElement.classList.remove('ring-2', 'ring-blue-300', 'bg-blue-50');
                
                // 表示部分を更新
                this.updateDisplaySection();
            }
            
            saveBasicInfo() {
                const inputs = this.projectElement.querySelectorAll('.basic-info-input');
                const newData = {};
                let hasErrors = false;
                
                inputs.forEach(input => {
                    const field = input.dataset.field;
                    let value = input.value.trim();
                    
                    // 必須フィールドの検証
                    if (input.required && !value) {
                        this.showInputError(input, '必須項目です');
                        hasErrors = true;
                        return;
                    }
                    
                    // 値のフォーマット
                    value = this.formatInputValue(field, value);
                    newData[field] = value;
                    
                    // エラー表示をクリア
                    this.clearInputError(input);
                });
                
                if (hasErrors) {
                    this.showNotification('入力内容に不備があります', 'error');
                    return false;
                }
                
                // プロジェクトデータを更新
                const projectIndex = parseInt(this.projectElement.dataset.projectIndex);
                if (window.DataFormatterApp?.projects?.[projectIndex]) {
                    Object.assign(window.DataFormatterApp.projects[projectIndex].basicInfo, newData);
                }
                
                return true;
            }
            
            restoreBasicInfo(originalData) {
                const inputs = this.projectElement.querySelectorAll('.basic-info-input');
                inputs.forEach(input => {
                    const field = input.dataset.field;
                    const value = originalData[field] || '';
                    const cleanValue = value.replace(/¥|円|個\/年|個/g, '');
                    input.value = cleanValue;
                    this.clearInputError(input);
                });
            }
            
            resetToOriginalData() {
                const projectIndex = parseInt(this.projectElement.dataset.projectIndex);
                const app = window.DataFormatterApp;
                
                if (app?.projects?.[projectIndex]) {
                    // 元の解析データに戻す（dataParserで再解析）
                    const originalProject = app.projects[projectIndex];
                    const fallbackData = app.dataParser.applyDataFallbacks({}, projectIndex + 1);
                    
                    // 元のデータを復元
                    Object.assign(originalProject.basicInfo, fallbackData);
                    
                    // 入力フィールドを更新
                    const inputs = this.projectElement.querySelectorAll('.basic-info-input');
                    inputs.forEach(input => {
                        const field = input.dataset.field;
                        const value = fallbackData[field] || '';
                        const cleanValue = value.replace(/¥|円|個\/年|個/g, '');
                        input.value = cleanValue;
                        this.clearInputError(input);
                    });
                }
            }
            
            formatInputValue(field, value) {
                if (!value) return value;
                
                switch (field) {
                    case '前回の注文単価':
                    case '前回注文加工費':
                        // 数値のみ抽出して¥を付加
                        const numValue = value.replace(/[^\d.]/g, '');
                        return numValue ? `¥${numValue}` : value;
                        
                    case '年間使用数':
                    case '在庫数':
                        // 数値のみ抽出
                        return value.replace(/[^\d]/g, '') || '0';
                        
                    default:
                        return value;
                }
            }
            
            validateBasicInfoInput(input) {
                const field = input.dataset.field;
                const value = input.value.trim();
                
                // 必須フィールドの検証
                if (input.required && !value) {
                    this.showInputError(input, '必須項目です');
                    return false;
                }
                
                // 数値フィールドの検証
                if ((field === '年間使用数' || field === '在庫数') && value) {
                    if (!/^\d+$/.test(value)) {
                        this.showInputError(input, '数値を入力してください');
                        return false;
                    }
                    if (parseInt(value) < 0) {
                        this.showInputError(input, '0以上の値を入力してください');
                        return false;
                    }
                }
                
                // 価格フィールドの検証
                if ((field === '前回の注文単価' || field === '前回注文加工費') && value) {
                    const numValue = value.replace(/[^\d.]/g, '');
                    if (numValue && (isNaN(parseFloat(numValue)) || parseFloat(numValue) < 0)) {
                        this.showInputError(input, '正しい金額を入力してください');
                        return false;
                    }
                }
                
                this.clearInputError(input);
                return true;
            }
            
            formatBasicInfoInput(input) {
                const field = input.dataset.field;
                input.value = this.formatInputValue(field, input.value);
            }
            
            showInputError(input, message) {
                input.classList.add('border-red-500', 'bg-red-50');
                
                // 既存のエラーメッセージを削除
                const existingError = input.parentElement.querySelector('.input-error');
                if (existingError) {
                    existingError.remove();
                }
                
                // エラーメッセージを追加
                const errorDiv = document.createElement('div');
                errorDiv.className = 'input-error text-xs text-red-600 mt-1';
                errorDiv.textContent = message;
                input.parentElement.appendChild(errorDiv);
            }
            
            clearInputError(input) {
                input.classList.remove('border-red-500', 'bg-red-50');
                const errorDiv = input.parentElement.querySelector('.input-error');
                if (errorDiv) {
                    errorDiv.remove();
                }
            }
            
            updateDisplaySection() {
                const projectIndex = parseInt(this.projectElement.dataset.projectIndex);
                const projectData = window.DataFormatterApp?.projects?.[projectIndex];
                
                if (!projectData) return;
                
                // 表示セクションのHTMLを再生成
                const basicInfoSection = this.projectElement.querySelector('.basic-info-display');
                if (basicInfoSection && window.DataFormatterApp?.uiGenerator) {
                    const newDisplayHTML = window.DataFormatterApp.uiGenerator.generateBasicInfoDisplayContent(projectData.basicInfo);
                    basicInfoSection.innerHTML = newDisplayHTML;
                }
            }
            
            updateProjectTitle() {
                const projectIndex = parseInt(this.projectElement.dataset.projectIndex);
                const projectData = window.DataFormatterApp?.projects?.[projectIndex];
                
                if (!projectData || !window.DataFormatterApp?.uiGenerator) return;
                
                const titleInfo = window.DataFormatterApp.uiGenerator.generateProjectTitle(projectData.basicInfo, projectIndex);
                const titleElement = this.projectElement.querySelector('h4');
                const subTitleElement = this.projectElement.querySelector('p');
                
                if (titleElement) {
                    titleElement.textContent = `${projectIndex + 1}. ${titleInfo.main}`;
                }
                
                if (subTitleElement && titleInfo.sub) {
                    subTitleElement.textContent = titleInfo.sub;
                } else if (subTitleElement) {
                    subTitleElement.textContent = '';
                }
            }
            
            updateDataQualityIndicator() {
                const projectIndex = parseInt(this.projectElement.dataset.projectIndex);
                const projectData = window.DataFormatterApp?.projects?.[projectIndex];
                
                if (!projectData || !window.DataFormatterApp?.uiGenerator) return;
                
                const qualityIndicator = this.projectElement.querySelector('.mt-3.pt-2.border-t');
                if (qualityIndicator) {
                    const newIndicatorHTML = window.DataFormatterApp.uiGenerator.generateDataQualityIndicator(projectData.basicInfo);
                    qualityIndicator.innerHTML = newIndicatorHTML;
                }
            }
            
            showNotification(message, type = 'info') {
                if (window.DataFormatterApp?.notificationManager) {
                    if (type === 'success') {
                        window.DataFormatterApp.notificationManager.showSuccess(message);
                    } else if (type === 'error') {
                        window.DataFormatterApp.notificationManager.showError(message);
                    } else {
                        window.DataFormatterApp.notificationManager.showSuccess(message);
                    }
                }
            }
            
            setupPriceFormatting() {
                const priceInputs = this.projectElement.querySelectorAll('.application-price, .total-amount');
                priceInputs.forEach(input => {
                    input.addEventListener('input', (e) => {
                        e.target.value = this.formatPrice(e.target.value);
                        this.updateCalculationDisplay();
                        this.triggerRealTimeValidation();
                    });
                    
                    input.addEventListener('blur', (e) => {
                        this.triggerRealTimeValidation(true); // 強制実行
                    });
                });
            }
            
            setupCalculationUpdates() {
                const quantityInput = this.projectElement.querySelector('.order-quantity');
                quantityInput?.addEventListener('input', () => {
                    this.updateCalculationDisplay();
                    this.triggerRealTimeValidation();
                });
                
                quantityInput?.addEventListener('blur', () => {
                    this.triggerRealTimeValidation(true);
                });
            }
            
            setupTaxIncludedToggle() {
                const taxIncludedCheckbox = this.projectElement.querySelector('.tax-included');
                taxIncludedCheckbox?.addEventListener('change', () => {
                    this.updateCalculationDisplay();
                    this.triggerRealTimeValidation(true);
                    
                    // 税込チェック時のビジュアルフィードバック
                    const priceSection = this.projectElement.querySelector('.bg-green-50');
                    if (taxIncludedCheckbox.checked) {
                        priceSection?.classList.add('ring-2', 'ring-green-300');
                    } else {
                        priceSection?.classList.remove('ring-2', 'ring-green-300');
                    }
                });
            }
            
            setupRealTimeValidation() {
                // 全ての入力フィールドを監視
                const watchedInputs = this.projectElement.querySelectorAll(
                    '.order-quantity, .application-price, .total-amount, .zaico-model, .supplier-model, .zaico-drawing-no, .supplier-drawing-no'
                );
                
                watchedInputs.forEach(input => {
                    input.addEventListener('input', () => {
                        this.addInputValidationStyle(input);
                        this.triggerRealTimeValidation();
                    });
                    
                    input.addEventListener('focus', () => {
                        this.addFocusStyle(input);
                    });
                    
                    input.addEventListener('blur', () => {
                        this.removeFocusStyle(input);
                        this.triggerRealTimeValidation(true);
                    });
                });
                
                // チェックボックスも監視
                const checkboxes = this.projectElement.querySelectorAll(
                    '.best-price, .special-reason, .special-adoption, .model-exception, .no-drawing-number, .drawing-exception, .processing-fee-comparison, .processing-fee-increase'
                );
                
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        this.triggerRealTimeValidation(true);
                    });
                });
                
                // テキストエリアも監視
                const textareas = this.projectElement.querySelectorAll('textarea');
                textareas.forEach(textarea => {
                    textarea.addEventListener('input', () => {
                        this.triggerRealTimeValidation();
                    });
                });
            }
            
            setupVisualFeedback() {
                // リアルタイム検証結果表示エリアを作成
                const existingResult = this.projectElement.querySelector('.validation-result');
                if (existingResult) {
                    const realtimeIndicator = document.createElement('div');
                    realtimeIndicator.className = 'realtime-validation mt-3 p-2 rounded text-sm';
                    realtimeIndicator.style.display = 'none';
                    existingResult.parentNode.insertBefore(realtimeIndicator, existingResult);
                }
            }
            
            triggerRealTimeValidation(forceValidation = false) {
                if (!this.isRealTimeEnabled && !forceValidation) return;
                
                // デバウンス処理（500ms）
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    this.performRealTimeValidation();
                }, forceValidation ? 0 : 500);
            }
            
            performRealTimeValidation() {
                try {
                    const projectIndex = parseInt(this.projectElement.dataset.projectIndex);
                    const projectData = window.DataFormatterApp?.projects?.[projectIndex];
                    
                    if (!projectData) return;
                    
                    // キャッシュキーの生成
                    const cacheKey = this.generateCacheKey();
                    
                    // キャッシュから結果を取得
                    if (this.validationCache.has(cacheKey)) {
                        const cachedResult = this.validationCache.get(cacheKey);
                        this.displayRealTimeResult(cachedResult, projectData);
                        return;
                    }
                    
                    // 検証実行
                    const result = this.validator.validateProject(this.projectElement, projectData);
                    
                    // 結果をキャッシュ
                    this.validationCache.set(cacheKey, result);
                    
                    // リアルタイム結果表示
                    this.displayRealTimeResult(result, projectData);
                    
                    // 入力フィールドの状態更新
                    this.updateInputStates(result);
                    
                } catch (error) {
                    console.warn('リアルタイム検証エラー:', error);
                }
            }
            
            generateCacheKey() {
                const inputs = this.projectElement.querySelectorAll('input, textarea, select');
                const values = Array.from(inputs).map(input => {
                    if (input.type === 'checkbox') {
                        return input.checked ? '1' : '0';
                    }
                    return input.value || '';
                });
                return values.join('|');
            }
            
            displayRealTimeResult(result, projectData) {
                const realtimeIndicator = this.projectElement.querySelector('.realtime-validation');
                if (!realtimeIndicator) return;
                
                const completionRate = this.calculateCompletionRate(result);
                const statusColor = result.overallCheck ? 'green' : 
                                  completionRate >= 70 ? 'yellow' : 'red';
                
                realtimeIndicator.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="mr-2">${result.overallCheck ? '✅' : '⚠️'}</span>
                            <span class="font-medium text-${statusColor}-700">
                                ${result.overallCheck ? 'リアルタイム検証: 全項目OK' : `リアルタイム検証: ${completionRate}% 完了`}
                            </span>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${this.getTimeStamp()}
                        </div>
                    </div>
                    
                    <div class="mt-2 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-1 text-xs">
                        ${this.generateQuickStatusBadges(result)}
                    </div>
                    
                    ${this.generateRealTimeHints(result, projectData)}
                `;
                
                realtimeIndicator.className = `realtime-validation mt-3 p-2 rounded text-sm bg-${statusColor}-50 border border-${statusColor}-200`;
                realtimeIndicator.style.display = 'block';
            }
            
            calculateCompletionRate(result) {
                const checks = [result.orderCheck, result.priceCheck, result.modelCheck, result.drawingCheck, result.processingFeeCheck, result.unitPriceMatch];
                const passedChecks = checks.filter(check => check).length;
                return Math.round((passedChecks / checks.length) * 100);
            }
            
            generateQuickStatusBadges(result) {
                const badges = [
                    { key: 'orderCheck', label: '注文数', value: result.orderCheck },
                    { key: 'priceCheck', label: '価格', value: result.priceCheck },
                    { key: 'modelCheck', label: '型番', value: result.modelCheck },
                    { key: 'drawingCheck', label: '図番', value: result.drawingCheck },
                    { key: 'processingFeeCheck', label: '加工費', value: result.processingFeeCheck },
                    { key: 'unitPriceMatch', label: '単価', value: result.unitPriceMatch }
                ];
                
                return badges.map(badge => {
                    const bgColor = badge.value ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                    const icon = badge.value ? '✓' : '✗';
                    return `<span class="px-2 py-1 rounded ${bgColor}">${icon} ${badge.label}</span>`;
                }).join('');
            }
            
            generateRealTimeHints(result, projectData) {
                const hints = [];
                
                if (!result.orderCheck) {
                    const annualUsage = parseInt(projectData.basicInfo['年間使用数']) || 0;
                    if (annualUsage > 0) {
                        const suggestedMin = Math.ceil(annualUsage / 2);
                        const suggestedMax = annualUsage;
                        hints.push(`💡 推奨注文数: ${suggestedMin}〜${suggestedMax}個`);
                    }
                }
                
                if (!result.priceCheck && result.calculatedPrice) {
                    const previousPriceStr = projectData.basicInfo['前回の注文単価'] || '¥0';
                    const previousPrice = parseFloat(previousPriceStr.replace(/[¥,\s]/g, ''));
                    if (parseFloat(result.calculatedPrice) > previousPrice) {
                        hints.push(`💰 前回注文単価より高額です。相見積もりまたは特別採用の理由が必要`);
                    }
                }
                
                if (!result.modelCheck) {
                    hints.push(`🔢 ZAICO型番と購買先型番を入力するか、型番不一致の理由を記載してください`);
                }
                
                if (!result.drawingCheck) {
                    hints.push(`📐 ZAICO図番と購買先図番を入力するか、図番なし・図番不一致の理由を記載してください`);
                }
                
                if (!result.processingFeeCheck && result.hasProcessingFeeComparison) {
                    const previousProcessingFeeStr = projectData.basicInfo['前回注文加工費'] || '¥0';
                    const previousProcessingFee = parseFloat(previousProcessingFeeStr.replace(/[¥,\s]/g, ''));
                    const currentProcessingFee = parseFloat((result.currentProcessingFee || '0').replace(/[¥,\s]/g, ''));
                    
                    if (!result.currentProcessingFee) {
                        hints.push(`🔧 今回の加工費を入力してください`);
                    } else if (currentProcessingFee > previousProcessingFee) {
                        hints.push(`🔧 前回加工費より高額です。加工費上昇の理由を記載してください`);
                    }
                }
                
                if (!result.unitPriceMatch && result.calculatedPrice && result.applicationPrice) {
                    hints.push(`📊 申請単価と計算単価が一致しません。総額または注文数を確認してください`);
                }
                
                return hints.length > 0 ? `
                    <div class="mt-2 pt-2 border-t border-gray-200">
                        <div class="text-xs text-gray-600">
                            ${hints.slice(0, 2).map(hint => `<div class="mb-1">${hint}</div>`).join('')}
                        </div>
                    </div>
                ` : '';
            }
            
            updateInputStates(result) {
                // 注文数フィールドの状態更新
                const orderQuantityInput = this.projectElement.querySelector('.order-quantity');
                this.updateInputValidationState(orderQuantityInput, result.orderCheck);
                
                // 申請単価フィールドの状態更新
                const applicationPriceInput = this.projectElement.querySelector('.application-price');
                this.updateInputValidationState(applicationPriceInput, result.unitPriceMatch);
                
                // 商品総額フィールドの状態更新
                const totalAmountInput = this.projectElement.querySelector('.total-amount');
                this.updateInputValidationState(totalAmountInput, result.unitPriceMatch);
                
                // 型番フィールドの状態更新
                const zaicoModelInput = this.projectElement.querySelector('.zaico-model');
                const supplierModelInput = this.projectElement.querySelector('.supplier-model');
                this.updateInputValidationState(zaicoModelInput, result.modelCheck);
                this.updateInputValidationState(supplierModelInput, result.modelCheck);
            }
            
            updateInputValidationState(input, isValid) {
                if (!input) return;
                
                // 既存のバリデーションクラスを削除
                input.classList.remove('border-green-500', 'border-red-500', 'border-yellow-500');
                
                // 値が入力されている場合のみ色付け
                if (input.value.trim() !== '') {
                    if (isValid) {
                        input.classList.add('border-green-500');
                    } else {
                        input.classList.add('border-red-500');
                    }
                }
            }
            
            addInputValidationStyle(input) {
                input.classList.add('border-blue-500');
                setTimeout(() => {
                    input.classList.remove('border-blue-500');
                }, 300);
            }
            
            addFocusStyle(input) {
                input.parentElement?.classList.add('ring-2', 'ring-blue-500');
            }
            
            removeFocusStyle(input) {
                input.parentElement?.classList.remove('ring-2', 'ring-blue-500');
            }
            
            getTimeStamp() {
                return new Date().toLocaleTimeString('ja-JP', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
            }
            
            toggleRealTimeValidation(enabled) {
                this.isRealTimeEnabled = enabled;
                const realtimeIndicator = this.projectElement.querySelector('.realtime-validation');
                if (!enabled && realtimeIndicator) {
                    realtimeIndicator.style.display = 'none';
                }
            }
            
            clearValidationCache() {
                this.validationCache.clear();
            }
            
            setupCheckboxToggles() {
                const checkboxConfigs = [
                    { 
                        checkbox: '.special-reason', 
                        textArea: '.special-reason-text',
                        description: '注文数の特別理由'
                    },
                    { 
                        checkbox: '.special-adoption', 
                        textArea: '.special-adoption-text',
                        description: '価格上昇の特別事情'
                    },
                    { 
                        checkbox: '.model-exception', 
                        textArea: '.model-exception-text',
                        description: '型番不一致の特別事情'
                    },
                    { 
                        checkbox: '.drawing-exception', 
                        textArea: '.drawing-exception-text',
                        description: '図番不一致の特別事情'
                    },
                    { 
                        checkbox: '.processing-fee-increase', 
                        textArea: '.processing-fee-increase-text',
                        description: '加工費上昇の特別事情'
                    }
                ];
                
                checkboxConfigs.forEach(({ checkbox, textArea, description }) => {
                    const checkboxElement = this.projectElement.querySelector(checkbox);
                    const textAreaElement = this.projectElement.querySelector(textArea);
                    
                    checkboxElement?.addEventListener('change', function() {
                        if (textAreaElement) {
                            textAreaElement.style.display = this.checked ? 'block' : 'none';
                            
                            // チェック時にテキストエリアにフォーカス
                            if (this.checked) {
                                const textarea = textAreaElement.querySelector('textarea');
                                setTimeout(() => textarea?.focus(), 100);
                            }
                        }
                    });
                });
                
                // 図番なしチェックボックスの特別処理
                const noDrawingCheckbox = this.projectElement.querySelector('.no-drawing-number');
                const drawingInputs = this.projectElement.querySelectorAll('.zaico-drawing-no, .supplier-drawing-no');
                
                noDrawingCheckbox?.addEventListener('change', function() {
                    drawingInputs.forEach(input => {
                        if (this.checked) {
                            input.disabled = true;
                            input.style.backgroundColor = '#f3f4f6';
                            input.value = '';
                        } else {
                            input.disabled = false;
                            input.style.backgroundColor = '';
                        }
                    });
                });
                
                // 加工費比較チェックボックスの特別処理
                const processingFeeComparisonCheckbox = this.projectElement.querySelector('.processing-fee-comparison');
                const processingFeeSection = this.projectElement.querySelector('.processing-fee-section');
                
                processingFeeComparisonCheckbox?.addEventListener('change', function() {
                    if (processingFeeSection) {
                        processingFeeSection.style.display = this.checked ? 'block' : 'none';

                        // チェック時に前回加工費を表示し、入力フィールドにフォーカス
                        if (this.checked) {
                            // 前回加工費を取得して表示
                            const projectElement = this.closest('[data-project-index]');
                            const projectIndex = parseInt(projectElement.dataset.projectIndex);
                            const projectData = window.DataFormatterApp?.projects?.[projectIndex];

                            const previousFeeDisplay = processingFeeSection.querySelector('.processing-fee-previous');
                            const applicationPriceDisplay = processingFeeSection.querySelector('.application-price-display');

                            if (previousFeeDisplay && projectData) {
                                const previousFee = projectData.basicInfo['前回注文加工費'] || '¥0';
                                previousFeeDisplay.textContent = previousFee;
                                previousFeeDisplay.className = previousFeeDisplay.className.replace('text-gray-600', 'text-green-700 font-medium');
                            }

                            if (applicationPriceDisplay) {
                                const applicationPriceInput = this.closest('[data-project-index]').querySelector('.application-price');
                                const currentPrice = applicationPriceInput?.value || '未入力';
                                applicationPriceDisplay.textContent = currentPrice === '未入力' ? '申請単価を入力してください' : currentPrice;
                            }

                            // 申請単価フィールドにフォーカス（参考用）
                            const applicationPriceInput = this.closest('[data-project-index]').querySelector('.application-price');
                            if (applicationPriceInput && !applicationPriceInput.value) {
                                setTimeout(() => applicationPriceInput?.focus(), 100);
                            }
                        }
                    }
                });
            }
            
            formatPrice(value) {
                value = value.replace(/[^\d.]/g, '');
                return value ? `¥${value}` : value;
            }
            
            updateCalculationDisplay() {
                const totalAmount = this.projectElement.querySelector('.total-amount')?.value;
                const orderQuantity = parseInt(this.projectElement.querySelector('.order-quantity')?.value);
                const taxIncluded = this.projectElement.querySelector('.tax-included')?.checked || false;
                const calculationDisplay = this.projectElement.querySelector('.calculation-display');
                
                if (totalAmount && orderQuantity > 0 && calculationDisplay) {
                    const calculatedPrice = this.validator.calculateUnitPrice(totalAmount, orderQuantity, taxIncluded);
                    const totalAmountNum = parseFloat(totalAmount.replace(/[¥,\s]/g, '')) || 0;
                    
                    let calculationDetails = '';
                    if (taxIncluded) {
                        const taxAmount = totalAmountNum / 11;
                        const totalWithoutTax = totalAmountNum - taxAmount;
                        calculationDetails = `
                            <div class="text-xs text-gray-600 mt-1">
                                📊 詳細計算: 税込${totalAmountNum.toLocaleString()}円 - 税額${Math.floor(taxAmount).toLocaleString()}円 = 税抜${Math.floor(totalWithoutTax).toLocaleString()}円<br>
                                単価計算: ${Math.floor(totalWithoutTax).toLocaleString()}円 ÷ ${orderQuantity}個 = ${calculatedPrice.toFixed(2)}円（小数第3位切り捨て）
                            </div>
                        `;
                    } else {
                        calculationDetails = `
                            <div class="text-xs text-gray-600 mt-1">
                                📊 詳細計算: ${totalAmountNum.toLocaleString()}円 ÷ ${orderQuantity}個 = ${calculatedPrice.toFixed(2)}円
                            </div>
                        `;
                    }
                    
                    calculationDisplay.innerHTML = `
                        <div class="flex items-center text-blue-700">
                            <span class="mr-2">${taxIncluded ? '💰' : '💡'}</span>
                            <strong>計算単価: ¥${calculatedPrice.toFixed(2)}</strong>
                            <span class="ml-2 px-2 py-1 rounded text-xs ${taxIncluded ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                                ${taxIncluded ? '税込計算' : '税抜計算'}
                            </span>
                        </div>
                        ${calculationDetails}
                    `;
                    calculationDisplay.style.display = 'block';
                } else if (calculationDisplay) {
                    calculationDisplay.style.display = 'none';
                }
            }
        }
        
        /**
         * テキストフォーマッタークラス
         * 検証結果をフォーマット済みテキストに変換して出力
         * @class TextFormatter
         */
        class TextFormatter {
            generateFormattedText(results) {
                const formattedTexts = results.map((result, index) => this.formatSingleResult(result, index));
                const totalAmountText = this.calculateTotalAmount(results);
                
                return results.length > 1 ? 
                    `${formattedTexts.join('\n\n')}\n\n${totalAmountText}` : 
                    formattedTexts.join('\n\n');
            }
            
            formatSingleResult(result, index) {
                const { projectData } = result;
                const itemName = projectData.basicInfo['仕様'] || '不明';
                const modelNumber = projectData.basicInfo['型番'] || '';
                const stockQuantity = projectData.basicInfo['在庫数'] || '0';
                const annualUsage = projectData.basicInfo['年間使用数'] || '0';
                const supplier = projectData.basicInfo['購買先'] || '未指定';
                const previousPrice = projectData.basicInfo['前回の注文単価'] || '¥0';
                const previousProcessingFee = projectData.basicInfo['前回注文加工費'] || '¥0';
                
                const orderReason = this.generateOrderReason(result, annualUsage);
                const priceReason = this.generatePriceReason(result, previousPrice);
                const modelReason = this.generateModelReason(result);
                const modelDisplay = this.getModelDisplay(result, modelNumber, itemName);
                
                // 加工費比較の表示を生成
                const processingFeeDisplay = this.generateProcessingFeeDisplay(result, projectData, previousProcessingFee);

                return `【${modelDisplay}】
検証${result.overallCheck ? 'OK' : 'NG'}
注文数${result.orderCheck ? 'OK' : 'NG'}
　年間使用数：${annualUsage}個
　在庫数：${stockQuantity}個
　注文数：${result.orderQuantity}個
　⇒${orderReason}
${processingFeeDisplay}型番/仕様${result.modelCheck ? 'OK' : 'NG'}
　ZAICO型番　：${result.zaicoModel}
　見積/購買先：${result.supplierModel}
　⇒${modelReason}`;
            }

            generateProcessingFeeDisplay(result, projectData, previousProcessingFee) {
                // 加工費比較がONの場合は加工費情報を表示、OFFの場合は単価情報を表示
                if (result.hasProcessingFeeComparison && result.processingFeeDetails) {
                    const details = result.processingFeeDetails;
                    const applicationPrice = details.currentFee;

                    return `加工費比較${result.processingFeeCheck ? 'OK' : 'NG'}
　前回注文加工費：¥${details.previousFee}
　申請単価：¥${applicationPrice}
　⇒${this.generateProcessingFeeReason(result, details)}
`;
                } else {
                    // 従来の単価比較表示
                    const previousPrice = projectData.basicInfo['前回の注文単価'] || '¥0';
                    const priceReason = this.generatePriceReason(result, previousPrice);

                    return `単価${result.priceCheck ? 'OK' : 'NG'}
　前回注文単価：${previousPrice}
　今回単価：¥${result.calculatedPrice}
${priceReason}`;
                }
            }

            generateProcessingFeeReason(result, details) {
                if (details.isDecrease || details.isSame) {
                    return '前回注文加工費以下のためOK';
                } else if (details.isIncrease && result.hasProcessingFeeIncrease && result.processingFeeIncreaseDetail) {
                    return result.processingFeeIncreaseDetail;
                } else if (details.isIncrease) {
                    return '申請単価が前回注文加工費より高額です。理由の記載が必要';
                }
                return '比較結果不明';
            }

            generateOrderReason(result, annualUsage) {
                const annualUsageNum = parseInt(annualUsage);
                const isInNormalRange = result.orderQuantity >= annualUsageNum / 2 && result.orderQuantity <= annualUsageNum;
                
                if (result.hasSpecialReason && result.specialReasonDetail) {
                    return result.specialReasonDetail;
                } else if (isInNormalRange) {
                    return '半年から1年分の注文数のためOK';
                } else {
                    return '注文数が年間使用数の半分未満または年間使用数を超えています';
                }
            }
            
            generatePriceReason(result, previousPrice) {
                const calculatedPrice = parseFloat(result.calculatedPrice);
                const previousPriceNum = parseFloat(previousPrice.replace(/[¥,\s]/g, ''));
                
                if (calculatedPrice <= previousPriceNum) {
                    return '　⇒前回注文単価以下のためOK\n';
                } else if (calculatedPrice > previousPriceNum && result.isBestPrice) {
                    return '　⇒相見積もりで最安値のためOK\n';
                } else if (calculatedPrice > previousPriceNum && result.hasSpecialAdoption && result.specialAdoptionDetail) {
                    return `　⇒${result.specialAdoptionDetail}\n`;
                }
                return '';
            }
            
            generateModelReason(result) {
                if (result.modelCheck) {
                    return result.hasModelException ? result.modelExceptionDetail : '一致確認';
                }
                return '型番が一致していません';
            }
            
            getModelDisplay(result, modelNumber, itemName) {
                const modelsMatch = result.zaicoModel && result.supplierModel && 
                                 result.zaicoModel.replace(/\s/g, '') === result.supplierModel.replace(/\s/g, '');
                
                // 型番が一致している場合はそれを表示
                if (modelsMatch) {
                    return result.zaicoModel;
                }
                
                // 型番 → 物品名の優先順位
                if (modelNumber && !modelNumber.includes('TYPE-')) {
                    return modelNumber;
                }
                
                if (itemName && !itemName.includes('物品')) {
                    return itemName;
                }
                
                return `案件${result.index + 1}`;
            }
            
            calculateTotalAmount(results) {
                const totalAmountWithTax = results.reduce((total, result) => {
                    const totalAmount = parseFloat(result.totalAmount.replace(/[¥,\s]/g, '')) || 0;
                    return total + totalAmount;
                }, 0);
                
                return `税抜総額：¥${totalAmountWithTax.toLocaleString()}`;
            }
        }
        
        /**
         * バージョン管理クラス
         * アプリケーションのバージョン情報と更新履歴を管理
         * @class VersionManager
         */
        class VersionManager {
            constructor(version) {
                this.version = version;
                this.releaseDate = new Date().toLocaleDateString('ja-JP');
                this.versionHistory = this.getVersionHistory();
            }
            
            getVersionHistory() {
                return [
                    {
                        version: '3.0.0',
                        date: '2025年1月',
                        type: 'major',
                        title: '🔄 完全リファクタリング・コード品質向上',
                        changes: [
                            '🏗️ コード構造の最適化: クラス設計の見直しと責務の明確化',
                            '📋 バージョン管理の強化: セマンティックバージョニングの厳格な運用',
                            '📝 更新履歴の整理: 変更内容の明確な記録と追跡性の向上',
                            '🔧 保守性の向上: コードの可読性と拡張性の改善',
                            '📖 ドキュメント整備: コード内コメントとバージョン情報の充実',
                            '⚡ 全クラスへのJSDoc形式コメント追加'
                        ]
                    },
                    {
                        version: '2.4.3',
                        date: '2024年12月',
                        type: 'patch',
                        title: '📋 出力表示機能改善',
                        changes: [
                            '🎯 条件分岐表示: 加工費比較ON時は加工費情報、OFF時は単価情報を表示',
                            '📊 専用表示形式: 加工費比較専用の出力フォーマット実装',
                            '🔧 新メソッド追加: generateProcessingFeeDisplay()とgenerateProcessingFeeReason()を実装',
                            '💡 情報の最適化: 重複する単価情報を排除し、適切な比較結果を表示',
                            '⚡ 出力精度向上: 前回注文加工費と申請単価の正確な比較結果を出力'
                        ]
                    },
                    {
                        version: '2.4.2',
                        date: '2024年12月',
                        type: 'patch',
                        title: '🔄 データマッピング機能強化',
                        changes: [
                            '🎯 キーマッピング実装: 生データの「前回の注文加工費」を基本情報の「前回注文加工費」に自動変換',
                            '📊 多様なキーワード対応: 「加工費」「加工料」「工賃」など関連キーワードの自動認識',
                            '🔍 データパーシング改善: 加工費関連フィールドの認識精度向上',
                            '🛠️ デバッグ機能追加: キーマッピング過程のコンソールログ出力',
                            '⚡ フォールバック処理最適化: 正しいマッピング後データでの基本情報構築'
                        ]
                    },
                    {
                        version: '2.4.1',
                        date: '2024年12月',
                        type: 'minor',
                        title: '🔧 加工費比較ロジック最適化',
                        changes: [
                            '🎯 比較方式変更: 前回注文加工費 vs 申請単価の直接比較に仕様変更',
                            '⚡ 操作簡略化: 今回加工費の手動入力を削除し、申請単価を自動使用',
                            '📊 UI改善: 前回注文加工費と申請単価の並列表示で比較結果を明確化',
                            '💡 自動連携: 申請単価フィールドとの完全自動連携システム',
                            '📝 説明文最適化: 新しい比較方式に対応した説明文とプレースホルダー更新'
                        ]
                    },
                    {
                        version: '2.4.0',
                        date: '2024年12月',
                        type: 'major',
                        title: '🚀 SPAS - 加工費分析機能強化版',
                        changes: [
                            '🎯 アプリケーション名称変更: スマート調達分析システム（SPAS）にリブランディング',
                            '📊 高度加工費比較機能: 詳細な差額・増減率分析とビジュアル表示',
                            '🔍 リアルタイム費用分析: 前回費用との即座比較と傾向分析',
                            '💡 インテリジェント警告システム: 費用上昇時の自動アラートと理由記載ガイダンス',
                            '🎨 UI/UX大幅改善: 直感的な操作性と視認性の向上',
                            '⚡ パフォーマンス最適化: 比較処理の高速化とメモリ効率改善'
                        ]
                    },
                    {
                        version: '2.3.4',
                        date: '2024年12月',
                        type: 'minor',
                        title: '🔧 加工費比較機能実装',
                        changes: [
                            '加工費比較チェックボックス: チェックを付けることで加工費の比較ができる機能',
                            '前回加工費との比較: 基本情報の前回注文加工費と今回の加工費を自動比較',
                            '加工費上昇時の理由記載: 加工費が上昇した場合の特別事情入力機能',
                            'リアルタイム検証対応: 加工費チェック結果のリアルタイム表示'
                        ]
                    },
                    {
                        version: '2.3.3',
                        date: '2024年12月',
                        type: 'minor',
                        title: '📐 図番チェック機能実装',
                        changes: [
                            '図番チェック機能: 型番チェックに加えて図番の検証機能を追加',
                            '図番なしオプション: 図番が存在しない場合のチェックボックス対応',
                            '図番不一致対応: 図番が一致しない場合の特別事情記載機能',
                            'フォーマット出力改善: 物品名・購買先・前回加工費の表示を削除'
                        ]
                    },
                    {
                        version: '2.3.2',
                        date: '2024年12月',
                        type: 'patch',
                        title: '⌨️ ショートカット完全削除',
                        changes: [
                            'Ctrl+Alt+V ショートカット削除: 更新履歴表示機能を削除',
                            'ブラウザ標準ショートカットとの競合解消: すべてのカスタムショートカットを削除',
                            'キーボード操作の単純化: ESCキー（モーダル閉じる）のみ保持',
                            'ユーザビリティ向上: ブラウザ本来の操作体験を優先'
                        ]
                    },
                    {
                        version: '2.3.1',
                        date: '2024年12月',
                        type: 'patch',
                        title: '⌨️ ショートカット機能調整',
                        changes: [
                            'Ctrl+Shift+V ショートカット削除: ブラウザ本来の「値で貼り付け」機能を復活',
                            'バージョン情報表示: 画面右上のボタンからのみアクセス可能に変更',
                            'キーボードショートカット: ESCキーによるモーダル閉じる機能は維持',
                            'ユーザビリティ向上: 標準的なブラウザ操作との整合性向上'
                        ]
                    },
                    {
                        version: '2.3.0',
                        date: '2024年12月',
                        type: 'minor',
                        title: '✏️ 基本情報編集機能実装',
                        changes: [
                            '基本情報の直接編集機能: 生データ不備への柔軟対応',
                            'インライン編集UI: 表示モードと編集モードの切り替え',
                            'リアルタイム検証連携: 編集内容の即座反映',
                            'データ品質向上: 手動補正による精度向上',
                            '編集状態の視覚的フィードバック: 自動生成・編集済みの区別表示',
                            '入力値検証: 必須項目・データ型・範囲チェック',
                            '元データ復元機能: 編集のリセット・キャンセル対応'
                        ]
                    },
                    {
                        version: '2.2.0',
                        date: '2024年12月',
                        type: 'minor',
                        title: '⚡ リアルタイム検証機能実装',
                        changes: [
                            'リアルタイム検証エンジン: 入力値変更時の即座検証',
                            'デバウンス機能: 500ms遅延で負荷軽減',
                            'ビジュアルフィードバック: 入力フィールドの状態表示',
                            'インテリジェントヒント: リアルタイム改善提案',
                            '検証キャッシュシステム: パフォーマンス最適化',
                            'リアルタイム機能制御: 有効/無効切り替え',
                            '一括検証の強化: プログレス表示と非同期処理'
                        ]
                    },
                    {
                        version: '2.1.1',
                        date: '2024年12月',
                        type: 'patch',
                        title: '📋 基本情報表示の仕様変更',
                        changes: [
                            '題目表示ルール変更: 型番 → 物品名の優先順位',
                            '基本情報の順番変更: 物品名、型番、在庫数、年間使用数、購買先、前回注文単価、前回注文加工費',
                            '新項目追加: 在庫数、前回注文加工費フィールド',
                            'データ品質評価基準の調整: より厳密な評価ロジック',
                            '申請データマッチング優先順位の最適化',
                            'フォーマット済みテキストの出力項目拡充'
                        ]
                    },
                    {
                        version: '2.1.0',
                        date: '2024年12月',
                        type: 'minor',
                        title: '🎯 データ表示・解析機能強化',
                        changes: [
                            'データ解析エンジンの完全刷新: 柔軟な区切り文字対応',
                            '「不明」表示の撲滅: インテリジェントなフォールバック機能',
                            'プロジェクトタイトルの自動生成: 複数候補からの最適選択',
                            'データ品質インジケーター: リアルタイム完成度表示',
                            '申請データマッチング強化: 正規化・部分マッチング対応',
                            '詳細ログ機能: デバッグ・トラブルシューティング支援'
                        ]
                    },
                    {
                        version: '2.0.0',
                        date: '2024年12月',
                        type: 'major',
                        title: '🚀 Major Update - 完全リファクタリング',
                        changes: [
                            'アーキテクチャ改善: モジュール化とクラス化による保守性向上',
                            'エラーハンドリング強化: 堅牢な例外処理とユーザーフレンドリーな通知',
                            'UI/UX向上: アニメーション、プログレス表示、レスポンシブデザイン',
                            'パフォーマンス最適化: DOM操作効率化、メモリリーク防止',
                            '拡張性強化: プラグイン可能な設計、新機能追加の容易さ',
                            '税込/税抜計算機能: 高精度な単価計算ロジック'
                        ]
                    },
                    {
                        version: '1.2.1',
                        date: '2024年11月',
                        type: 'patch',
                        title: '🔧 Bug Fixes & Improvements',
                        changes: [
                            '型番検証ロジックの修正',
                            '価格計算の精度向上',
                            'UIレスポンシブ対応の改善'
                        ]
                    },
                    {
                        version: '1.2.0',
                        date: '2024年10月',
                        type: 'minor',
                        title: '✨ Feature Updates',
                        changes: [
                            '一括検証機能の追加',
                            'フォーマット済みテキスト出力機能',
                            'クリップボードコピー機能'
                        ]
                    },
                    {
                        version: '1.1.0',
                        date: '2024年9月',
                        type: 'minor',
                        title: '🎯 Core Features',
                        changes: [
                            '複数案件対応の実装',
                            '申請データ自動マッチング',
                            'リアルタイム計算機能'
                        ]
                    },
                    {
                        version: '1.0.0',
                        date: '2024年8月',
                        type: 'major',
                        title: '🎉 Initial Release',
                        changes: [
                            '基本的なデータ整形機能',
                            '単一案件対応',
                            '基本的な検証機能'
                        ]
                    }
                ];
            }
            
            displayVersion() {
                const versionElement = document.getElementById('appVersion');
                if (versionElement) {
                    versionElement.textContent = `v${this.version}`;
                }
            }
            
            showVersionModal() {
                const modal = document.getElementById('versionModal');
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            }
            
            hideVersionModal() {
                const modal = document.getElementById('versionModal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            }
            
            logVersionInfo() {
                console.group(`🚀 SPAS (スマート調達分析システム) v${this.version}`);
                console.log(`📅 リリース日: ${this.releaseDate}`);
                console.log(`🔧 技術スタック: Vanilla JavaScript + Tailwind CSS`);
                console.log(`📦 アーキテクチャ: Class-based Modular Design`);
                console.log(`🌐 ブラウザ対応: Modern Browsers (ES6+)`);
                console.log(`💡 新機能: 高度加工費分析 & インテリジェント警告システム`);
                console.groupEnd();
                
                // パフォーマンス情報も表示
                if (window.performance && window.performance.now) {
                    const loadTime = window.performance.now();
                    console.log(`⚡ 初期化時間: ${loadTime.toFixed(2)}ms`);
                }
            }
            
            getCurrentVersion() {
                return {
                    version: this.version,
                    releaseDate: this.releaseDate,
                    buildNumber: this.generateBuildNumber()
                };
            }
            
            generateBuildNumber() {
                const now = new Date();
                const year = now.getFullYear().toString().slice(-2);
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const hour = now.getHours().toString().padStart(2, '0');
                const minute = now.getMinutes().toString().padStart(2, '0');
                
                return `${year}${month}${day}.${hour}${minute}`;
            }
            
            checkForUpdates() {
                // 将来的な機能: 新しいバージョンの確認
                console.log('🔄 アップデートの確認機能は将来実装予定です');
            }
        }
        
        /**
         * 通知管理クラス
         * ユーザーへのエラー・成功メッセージの表示を管理
         * @class NotificationManager
         */
        class NotificationManager {
            showError(message) {
                this.showNotification(message, 'error');
            }
            
            showSuccess(message) {
                this.showNotification(message, 'success');
            }
            
            showNotification(message, type) {
                const elementId = type === 'error' ? 'errorMessage' : 'successMessage';
                const textId = type === 'error' ? 'errorText' : 'successText';
                
                const notificationElement = document.getElementById(elementId);
                const textElement = document.getElementById(textId);
                
                if (notificationElement && textElement) {
                    textElement.textContent = message;
                    notificationElement.style.display = 'block';
                    
                    // 3秒後に自動で非表示
                    setTimeout(() => {
                        notificationElement.style.display = 'none';
                    }, 3000);
                }
            }
        }
        
        /**
         * アプリケーション初期化
         * DOMContentLoaded時にアプリケーションインスタンスを生成し、
         * グローバルにアクセス可能にする
         */
        document.addEventListener('DOMContentLoaded', () => {
            const app = new DataFormatterApp();
            
            // グローバルにアプリインスタンスを設定（デバッグ用）
            window.DataFormatterApp = app;
            
            // キーボードショートカット
            document.addEventListener('keydown', (e) => {
                // ESCキーでモーダルを閉じる
                if (e.key === 'Escape') {
                    app.versionManager.hideVersionModal();
                }
                
                // 他のショートカットはすべて削除済み
                // Ctrl+Shift+V = ブラウザ標準の「値で貼り付け」
                // Ctrl+Alt+V = 削除済み（ブラウザ標準機能を優先）
            });
            
            // ページ読み込み完了をコンソールに表示
            console.group(`🎉 SPAS v${app.version} - Smart Procurement Analysis System`);
            console.log('🚀 システム初期化完了：次世代調達分析プラットフォーム');
            console.log('🔄 v3.0.0 新機能: コード構造の最適化とリファクタリング');
            console.log('📋 バージョン管理強化: セマンティックバージョニングの厳格な運用');
            console.log('⚡ リアルタイム検証エンジンが稼働中');
            console.log('✏️ 基本情報編集機能が利用可能');
            console.log('📊 データ品質管理システムが稼働中');
            console.log('💰 税込/税抜自動計算機能が対応済み');
            console.log('🔢 型番チェック機能が稼働中');
            console.log('📐 図番チェック機能が稼働中');
            console.log('🔧 最適化済み加工費分析機能が実装済み');
            console.log('💡 インテリジェント警告システムが稼働中');
            console.log('📱 バージョン情報: 画面右上のボタンから表示可能');
            console.log('🔧 開発者向け: window.DataFormatterApp でアプリインスタンスにアクセス可能');
            console.groupEnd();
        });
    </script>
</body>
</html>
